<?php

namespace App\Http\Controllers\Api;

use App\DeliveryManShift;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use App\Http\Requests;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\DB;
use App\Model\User;
use App\Model\UserPermission;
use App\Model\LoyaltyPoint;
use App\Model\UserDevice;
use App\Http\Requests\Admin\UserAddRequest;
use JWTAuthException;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\Hash;
use App\Model\Restaurant;
use App\Model\PrintClassUser;
use App\Model\PrintClass;
use App\Model\Order;
use App\Model\Bill;
use App\Model\EmployeeTableAssignment;
use App\Model\OrderedItem;
use App\Model\WaiterTip;
use App\Model\OrderBookedTable;
use App\Model\OrderReceipt;
use App\Model\HistoryPrintDocket;
use App\Model\WaCashSales;
use App\Model\WaCashSalesItem;
use App\Model\WaAccountingPeriod;

//use DB;
use App\Model\Feedback;
use App\Model\DjRequest;
use App\Model\WaGlTran;
use App\Model\WaDebtorTran;
use App\Model\WaChartsOfAccount;
use App\Model\WaLocationAndStore;
use App\Model\TaxManager;
use App\Model\WaCustomer;
use App\Model\Route;
use App\Model\Reservation;
use App\Model\ReservationEmail;
use App\Model\UserCardDetail;
use App\Model\Wallet;
use App\Model\PaymentMethod;
use App\Model\BillOrderRelation;
use App\Model\DeliveryCentres;
use App\Model\WalletTransaction;
use App\Model\WaStockMove;
use App\Model\WaInventoryItem;
use App\Model\WaShift;
use App\Model\Vehicle;
use App\Model\WaInternalRequisition;
use App\Model\WaNumerSeriesCode;
use App\Model\WaSoldButUnbookedItem;
use App\Model\WaInventoryLocationTransfer;
use App\Model\WaRouteCustomer;
use App\Model\WaSalesOrders;
use App\Model\WaSalesOrderItems;
use Carbon\Carbon;
use GuzzleHttp\Client;
use Illuminate\Support\Facades\Storage;
use Tymon\JWTAuth\Facades\JWTAuth;
use App\Services\MappingService;

class SalesController extends Controller
{
    private $user;
    private $uploadsfolder;

    public function __construct(User $user)
    {
        $this->user = $user;
        $this->uploadsfolder = asset('uploads/');
    }

    public function sales_order_checkout(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required|exists:users,id',
            'items' => 'required|array',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        }
        $check = DB::transaction(function () use ($request) {

            $number = getCodeWithNumberSeries('Sales Order');
            $item_adj = WaNumerSeriesCode::where('module', 'Sales Order')->first();
            $parent = new WaSalesOrders();
            $parent->user_id = $request->user_id;
            $parent->document_no = $number;
            $dateTime = date('Y-m-d H:i:s');

            $parent->save();
            $childs = [];
            foreach ($request->items as $key => $value) {
                $childs[] = [
                    'user_id' => $request->user_id,
                    'stock_code_id' => $value['stock_code_id'] ?? NULL,
                    'stockcode' => $value['stockcode'] ?? NULL,
                    'description' => $value['description'] ?? NULL,
                    'price' => $value['price'] ?? NULL,
                    'category_name' => $value['cateName'] ?? NULL,
                    'minimum_price' => $value['minmanPrice'] ?? NULL,
                    'required_qty' => $value['requiredQty'] ?? NULL,
                    'comment' => $value['comment'] ?? NULL,
                    'order_from' => $value['orderFrom'] ?? NULL,
                    'total' => $value['total'] ?? NULL,
                    'created_at' => $dateTime,
                    'updated_at' => $dateTime,
                    'wa_sales_orders_id' => $parent->id,
                ];
            }
            if (count($childs) > 0) {
                WaSalesOrderItems::insert($childs);
            }
            updateUniqueNumberSeries('Sales Order', $number);
            return $parent;
        });
        if ($check) {
            return response()->json(['status' => true, 'message' => 'Sales order created successfully', 'data' => @$check->document_no]);
        }
        return response()->json(['status' => false, 'message' => 'Something went wrong']);
    }

    public function registerForApiKey(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'name' => 'required|max:255',
            'password' => 'required|max:30|min:6',
            'phone_number' => 'required|numeric|unique:users',
            'email' => 'required|email|max:255|unique:users'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            $user = (object)[];
            return response()->json(['status' => false, 'message' => $error, 'userDetail' => $user]);
        } else {
            $row = new User();
            $row->name = $request->name;
            $row->role_id = 10;
            $row->email = $request->email;
            $row->phone_number = $request->phone_number;
            $row->password = bcrypt($request->password);
            $row->status = '1';
            $row->save();
            $user = $row;
            return response()->json(['status' => true, 'message' => 'User created successfully', 'userDetail' => $user]);
        }
    }

    public function getWalletBalance(Request $request)
    {


        $validator = Validator::make($request->all(), [
            'phone_number' => 'required',
        ]);

        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {

            $data['balance'] = $this->getWalletBalanceByPhoneNumber($request->phone_number);
            return response()->json(['status' => true, 'message' => 'Wallet amount', 'data' => $data]);
        }
    }

    public function addWalletBalanceByLoyalityPoint(Request $request)
    {


        $validator = Validator::make($request->all(), [
            'user_id' => 'required',

            'loyality_points' => 'required',
        ]);

        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {


            $user = User::where('id', $request->user_id)->first();
            if ($user) {
                $haveLoyaltYPoint = $this->getLoyaltyPointsByUserId($request->user_id);

                //dd($haveLoyaltYPoint);
                if ($request->loyality_points <= $haveLoyaltYPoint) {
                    $row = new WalletTransaction();
                    $row->phone_number = $user->phone_number;
                    $row->entry_type = 'Loyalty Top Up';
                    $row->amount = $request->loyality_points;
                    $row->user_id = $user->id;
                    $row->save();
                    $this->updateWalletAmount($user->phone_number);
                    $spentLoyaltyPoint = new LoyaltyPoint();
                    $spentLoyaltyPoint->wallet_transaction_id = $row->id;
                    $spentLoyaltyPoint->points = $request->loyality_points;
                    $spentLoyaltyPoint->points_source = 'TOPUP';
                    $spentLoyaltyPoint->user_id = $request->user_id;
                    $spentLoyaltyPoint->status = 'SPENT';
                    $spentLoyaltyPoint->save();


                    $haveLoyaltYPoint = $this->getLoyaltyPointsByUserId($request->user_id);
                    return response()->json(['status' => true, 'message' => 'Points redeemed successfully.', 'loyality_points' => $haveLoyaltYPoint]);
                } else {
                    return response()->json(['status' => false, 'message' => 'Do not have enough points to add in wallet.']);
                }
            } else {
                return response()->json(['status' => false, 'message' => 'Invalid User']);
            }
        }
    }


    public function addCardDetailsForCustomer(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'card_name' => 'required|max:255',
            'phone_number' => 'required',
            'email' => 'required|email|max:255',

        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {

            $row = UserCardDetail::where('user_id', $request->user_id)->first();
            if (!$row) {
                $row = new UserCardDetail();
            }
            $row->user_id = $request->user_id;
            $row->card_name = $request->card_name;
            $row->phone_number = $request->phone_number;
            $row->email = $request->email;
            $row->save();
            return response()->json(['status' => true, 'message' => 'Card added successfully']);
        }
    }

    public function deleteCardDetailsForCustomer(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',


        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {

            $row = UserCardDetail::where('user_id', $request->user_id)->delete();
            return response()->json(['status' => true, 'message' => 'Card deleted successfully']);
        }
    }


    public function getCardDetailsForCustomer(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',

        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {

            $row = UserCardDetail::where('user_id', $request->user_id)->first();
            if ($row) {
                $data = [
                    "card_name" => $row->card_name,
                    "phone_number" => $row->phone_number,
                    "email" => $row->email
                ];
                return response()->json(['status' => true, 'message' => 'Card details', 'data' => $data]);
            } else {
                return response()->json(['status' => false, 'message' => 'Do not have any card detail.']);
            }
        }
    }

    public function getApiKey(Request $request)
    {
        $credentials = $request->only('email', 'password');
        $token = null;
        try {
            if (!$token = JWTAuth::attempt($credentials)) {
                return response()->json(['invalid_email_or_password'], 422);
            }
        } catch (JWTAuthException $e) {
            return response()->json(['failed_to_create_token'], 500);
        }
        return response()->json(compact('token'));
    }


    public function signupCheck(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'name' => 'required|max:255',
            'email' => 'required|email|max:255|unique:users',
            //'dob'=>'required',
            'phone_number' => 'required|numeric|unique:users',

        ]);

        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            $user = (object)[];
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $otp = $this->randomOtp(4);
            //$otp  = '1234';
            //send otp code start from here
            $otp_is_sent = $this->sendOtpForUsers($otp, $request->phone_number, $request->name);
            //send otp code end from here
            return response()->json(['status' => true, 'message' => 'Please verify the OTP', 'otp' => $otp, 'otp_is_sent' => $otp_is_sent]);
        }
    }

    public function signup(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'name' => 'required|max:255',
            'email' => 'required|email|max:255|unique:users',
            //'dob'=>'required',
            'phone_number' => 'required|numeric|unique:users',
            //'gender'=>'required',
            'nationality' => 'required',


            'password' => 'required|max:30|min:6',
            'device_type' => 'required',
            'device_id' => 'required',
            'profile_pic' => 'mimes:jpeg,jpg,png',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {

            $row = new User();
            $row->name = $request->name;
            $row->role_id = 11;
            $row->email = $request->email;

            $row->nationality = $request->nationality;
            $row->phone_number = $request->phone_number;
            $row->password = bcrypt($request->password);
            $row->status = '1';
            if (isset($request->dob) && $request->dob != '') {
                $row->dob = convertDMYtoYMD($request->dob);
            }

            if (isset($request->gender) && $request->gender != '') {
                $row->gender = $request->gender;
            }

            if ($request->file('profile_pic')) {
                $file = $request->file('profile_pic');
                $image = uploadwithresize($file, 'users', '186');
                $row->image = $image;
            }

            $row->save();

            $this->giveLoyalityzpointForSignup($row->id);
            $this->manageDeviceIdAndToken($row->id, $request->device_id, $request->device_type, 'add');
            $user = $this->getuserdetailfromObjectArray($row);
            return response()->json(['status' => true, 'message' => 'Registration successfully', 'userdetails' => $user]);
        }
    }

    public function getuserdetailfromObjectArray($row)
    {
        $user = (object)array(
            'userid' => $row->id,
            'profile_pic' => $row->image ? $this->uploadsfolder . '/users/' . $row->image : $this->uploadsfolder . '/nouser.jpg',
            'profile_pic_thumb' => $row->image ? $this->uploadsfolder . '/users/thumb/' . $row->image : $this->uploadsfolder . '/nouser.jpg',
            'name' => $row->name,
            'email' => $row->email,
            'dob' => isset($row->dob) ? date('d/m/Y', strtotime($row->dob)) : '',
            'phone_number' => $row->phone_number,
            'gender' => isset($row->gender) ? $row->gender : '',
            'nationality' => $row->nationality,
            'pending_order_count' => $this->getPendingorderCount($row->id),
            'loyalty_points' => $this->getLoyaltyPointsByUserId($row->id)

            //'thumb_profile_pic'=>$row->image?$this->uploadsfolder.'/users/thumb/'.$row->image:$this->uploadsfolder.'/nouser.jpg',


        );
        return $user;
    }

    public function getwaiterdetailfromObjectArray($row)
    {
        /*
            Daily Sales Summary
Month-Wise Sales Analysis
Dashboard Wise Sales Analysis
Void Bills
Transfer Bills
Compliment Bills
Pending Bills Per Waiter
*/

        $dashboard = UserPermission::where('role_id', $row->role_id)->where('module_name', 'dashboard')->where('module_action', 'view')->count();
        $saleanalysis = UserPermission::where('role_id', $row->role_id)->where('module_name', 'account-receivables')->where('module_action', 'view')->count();
        $viewBills = UserPermission::where('role_id', $row->role_id)->where('module_name', 'master-bills')->where('module_action', 'void')->count();
        $voidBills = UserPermission::where('role_id', $row->role_id)->where('module_name', 'master-bills')->where('module_action', 'void')->count();
        $transferBills = UserPermission::where('role_id', $row->role_id)->where('module_name', 'master-bills')->where('module_action', 'transfer')->count();

        $restro = Restaurant::whereId($row->restaurant_id)->first();
        $user = (object)array(
            'userid' => $row->id,
            'profile_pic' => $row->image ? $this->uploadsfolder . '/users/' . $row->image : $this->uploadsfolder . '/nouser.jpg',
            'profile_pic_thumb' => $row->image ? $this->uploadsfolder . '/users/thumb/' . $row->image : $this->uploadsfolder . '/nouser.jpg',
            'name' => $row->name,
            'email' => $row->email,
            'role_id' => $row->role_id,
            'phone_number' => $row->phone_number,
            'id_number' => $row->id_number,
            'wa_location_and_store_id' => $row->wa_location_and_store_id,
            'badge_number' => $row->badge_number,
            'is_dashboard' => ($dashboard > 0) ? true : false,
            'is_month_wise_sales' => ($saleanalysis > 0) ? true : false,
            'is_daily_sales' => ($saleanalysis > 0) ? true : false,
            'is_void_bill' => ($voidBills > 0) ? true : false,
            'is_transfer_bill' => ($transferBills > 0) ? true : false,
            'is_compliment_bill' => ($viewBills > 0) ? true : false,
            'is_pending_bill' => ($viewBills > 0) ? true : false,
            'date_employeed' => $row->date_employeed,
            'restaurant_id' => $row->restaurant_id,
            'restaurant_name' => getRestaurantNameById($row->restaurant_id),
            'latitude' => $restro->latitude,
            'longitude' => $restro->longitude
        );
        return $user;
    }


    public function login(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'Email_PhoneNo' => 'required',
            'password' => 'required',
            'device_type' => 'required',
            'device_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $user_name = $request->Email_PhoneNo;
            $password = bcrypt($request->password);
            $row = User::where('role_id', 11)
                ->where('email', $user_name)
                ->orWhere('phone_number', $user_name)
                ->first();
            if ($row && Hash::check($request->password, $row->password)) {
                $user = $this->getuserdetailfromObjectArray($row);

                $this->manageDeviceIdAndToken($row->id, $request->device_id, $request->device_type, 'add');


                return response()->json(['status' => true, 'message' => 'login successfully', 'userdetails' => $user, 'unseen_notification_count' => $this->getUnseenNotificationCount($row->id)]);
            } else {
                return response()->json(['status' => false, 'message' => 'Invalid username or password']);
            }
        }
    }

    public function getInventoryItem(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $getUserData = User::where('id', $request->user_id)->first();

            $data = WaInventoryItem::select(
                'id',
                'stock_id_code',
                'description',
                'standard_cost',
                'selling_price',
                'image',
                'minimum_order_quantity',
                DB::raw("(SELECT SUM(`qauntity`) from `wa_stock_moves` where `wa_stock_moves`.`stock_id_code` = `wa_inventory_items`.`stock_id_code` AND `wa_location_and_store_id`='" . $getUserData->wa_location_and_store_id . "') as totalQty")
            )
                ->having('totalQty', '>', 0)
                ->get();

            foreach ($data as $key => $value) {
                $data[$key]->image = "http://bizwizdevinstance.com/public/uploads/inventory_items/" . $value->image;
            }
            return response()->json(['status' => true, 'message' => 'Inventory Items.', 'data' => $data]);
        }
    }


    public function apiGetInventoryItems(Request $request)
    {
        $getUserData = JWTAuth::toUser($request->token);

        $data = WaInventoryItem::with(['getAllFromStockMoves'])->select(
            'id',
            'title',
            'stock_id_code',
            'description',
            'standard_cost',
            'selling_price',
            'image',
            'minimum_order_quantity',
            DB::raw("(SELECT `category_description` from `wa_inventory_categories` where `id` = `wa_inventory_items`.`wa_inventory_category_id`) as category_detail"))
            ->get()->map(function (WaInventoryItem $item) {
                $item->totalQty = $item->getAllFromStockMoves()->sum('qauntity');
                unset($item->getAllFromStockMoves);

                return $item;
            })->filter(function (WaInventoryItem $item) {
                return $item->totalQty > 0;
            })->values();


        $appUrl = env('APP_URL');
        foreach ($data as $key => $value) {
            $data[$key]->image = "$appUrl/uploads/inventory_items/" . $value->image;
        }
        return response()->json(['status' => true, 'message' => 'Inventory Items.', 'data' => $data]);
    }

    public function apiGetFoodInventoryItem(Request $request)
    {
        $getUserData = JWTAuth::toUser($request->token);

        // dd($getUserData->wa_location_and_store_id);


        $data = WaInventoryItem::whereHas('getInventoryCategoryDetail.getStockTypecategory', function ($query) {
            $query->where('slug', 'food');
        })
            ->select(
                'id',
                'stock_id_code',
                'description',
                'standard_cost',
                'selling_price',
                'image',
                'minimum_order_quantity',
                DB::raw("(SELECT `category_description` from `wa_inventory_categories` where `id` = `wa_inventory_items`.`wa_inventory_category_id`) as category_detail"),
                DB::raw("(SELECT SUM(`qauntity`) from `wa_stock_moves` where `wa_stock_moves`.`stock_id_code` = `wa_inventory_items`.`stock_id_code` AND `wa_location_and_store_id`='" . $getUserData->wa_location_and_store_id . "') as totalQty")
            )
            ->having('totalQty', '>', 0)
            ->get();

        foreach ($data as $key => $value) {
            $data[$key]->image = "http://bizwizdevinstance.com/public/uploads/inventory_items/" . $value->image;
        }


        return response()->json(['status' => true, 'message' => 'Inventory Items.', 'data' => $data]);
    }


    public function apiGetOtherInventoryItem(Request $request)
    {
        $getUserData = JWTAuth::toUser($request->token);


        $data = WaInventoryItem::whereHas('getInventoryCategoryDetail.getStockTypecategory', function ($query) {
            $query->where('slug', "!=", 'food');
        })
            ->select(
                'id',
                'stock_id_code',
                'description',
                'standard_cost',
                'selling_price',
                'image',
                'minimum_order_quantity',
                DB::raw("(SELECT `category_description` from `wa_inventory_categories` where `id` = `wa_inventory_items`.`wa_inventory_category_id`) as category_detail"),
                DB::raw("(SELECT SUM(`qauntity`) from `wa_stock_moves` where `wa_stock_moves`.`stock_id_code` = `wa_inventory_items`.`stock_id_code` AND `wa_location_and_store_id`='" . $getUserData->wa_location_and_store_id . "') as totalQty")
            )
            ->having('totalQty', '>', 0)
            ->get();

        foreach ($data as $key => $value) {
            $data[$key]->image = "http://bizwizdevinstance.com/public/uploads/inventory_items/" . $value->image;
        }
        return response()->json(['status' => true, 'message' => 'Inventory Items.', 'data' => $data]);
    }

    public function getAllInventoryItem(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'search' => 'nullable',
            'user_id' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        }
        $getUserData = User::where('id', $request->user_id)->first();

        $data = WaInventoryItem::select([
            'id',
            'stock_id_code',
            'description',
            'standard_cost',
            'selling_price',
            'minimum_order_quantity',
            DB::raw("(SELECT SUM(`qauntity`) from `wa_stock_moves` where `wa_stock_moves`.`stock_id_code` = `wa_inventory_items`.`stock_id_code` ) as totalQty"),
            DB::raw("(select wa_category_item_prices.price from wa_category_item_prices where wa_category_item_prices.item_id = wa_inventory_items.id and wa_category_item_prices.category_id = '" . @$getUserData->category_id . "' limit 1) as category_price"),
            DB::raw("(select wa_categories.title from wa_categories where wa_categories.id = '" . @$getUserData->category_id . "' limit 1) as category_name")
        ])
            ->where(function ($e) use ($request) {
                if ($request->search) {
                    $e->orWhere('stock_id_code', 'LIKE', $request->search . '%');
                    $e->orWhere('description', 'LIKE', $request->search . '%');
                }
            })
            ->limit(50)->get();
        return response()->json(['status' => true, 'message' => 'Inventory Items.', 'data' => $data]);
    }

    public function getAllInventoryItemByStockCode(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'stockcode' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $getUserData = User::where('id', $request->user_id)->first();

            $data = WaInventoryItem::select([
                'id',
                'stock_id_code',
                'description',
                'standard_cost',
                'selling_price',
                'minimum_order_quantity',
                DB::raw("(SELECT SUM(`qauntity`) from `wa_stock_moves` where `wa_stock_moves`.`stock_id_code` = `wa_inventory_items`.`stock_id_code`) as totalQty"),
                DB::raw("(select wa_category_item_prices.price from wa_category_item_prices where wa_category_item_prices.item_id = wa_inventory_items.id and wa_category_item_prices.category_id = '" . @$getUserData->category_id . "' limit 1) as category_price"),
                DB::raw("(select wa_categories.title from wa_categories where wa_categories.id = '" . @$getUserData->category_id . "' limit 1) as category_name")
            ])
                ->where('stock_id_code', $request->stockcode)
                ->get();
            return response()->json(['status' => true, 'message' => 'Inventory Items.', 'data' => $data]);
        }
    }

    public function getInventoryItemByStockCode(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'stockcode' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $getUserData = User::where('id', $request->user_id)->first();

            $data = WaInventoryItem::select([
                'id',
                'stock_id_code',
                'description',
                'standard_cost',
                'selling_price',
                'minimum_order_quantity',
                DB::raw("(SELECT SUM(`qauntity`) from `wa_stock_moves` where `wa_stock_moves`.`stock_id_code` = `wa_inventory_items`.`stock_id_code` AND `wa_location_and_store_id`='" . @$getUserData->wa_location_and_store_id . "') as totalQty"),
                DB::raw("(select wa_category_item_prices.price from wa_category_item_prices where wa_category_item_prices.item_id = wa_inventory_items.id and wa_category_item_prices.category_id = '" . @$getUserData->category_id . "' limit 1) as category_price"),
                DB::raw("(select wa_categories.title from wa_categories where wa_categories.id = '" . @$getUserData->category_id . "' limit 1) as category_name")
            ])
                ->having('totalQty', '>', 0)
                ->where('stock_id_code', $request->stockcode)
                ->get();
            return response()->json(['status' => true, 'message' => 'Inventory Items.', 'data' => $data]);
        }
    }

    public function getSalesManLogin(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'Email_PhoneNo' => 'required',
            'password' => 'required',
            'role_id' => 'required',
            'device_type' => 'required',
            'device_id' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $user_name = $request->Email_PhoneNo;
            $password = bcrypt($request->password);
            $row = User::where('role_id', $request->role_id)
                ->where('email', $user_name)
                ->orWhere('phone_number', $user_name)
                ->first();
            if ($row && Hash::check($request->password, $row->password)) {
                $allow_location_check = false; //make its true after location updation
                if ($allow_location_check == true) {
                    if (isset($request->longitude) && isset($request->latitude) && $request->latitude != "" && $request->longitude != "") {
                        $distance = $this->distance(
                            $request->latitude,
                            $request->longitude,
                            $row->userRestaurent->latitude,
                            $row->userRestaurent->longitude,
                            'K'
                        );
                        if ($distance <= 1) {
                            $user = $this->getwaiterdetailfromObjectArray($row);


                            $this->deleteDeviceTokenForAllUser($request->device_id);

                            $this->manageDeviceIdAndToken($row->id, $request->device_id, $request->device_type, 'add');
                            return response()->json(['status' => true, 'message' => 'login successfully', 'userdetails' => $user]);
                        } else {
                            return response()->json(['status' => false, 'message' => 'To view the Menu, you have to be within a radius of 1 Km from Brew Bistro Restaurant']);
                        }
                    } else {
                        return response()->json(['status' => false, 'message' => 'Location is required']);
                    }
                } else {
                    $user = $this->getwaiterdetailfromObjectArray($row);
                    $this->manageDeviceIdAndToken($row->id, $request->device_id, $request->device_type, 'add');
                    return response()->json(['status' => true, 'message' => 'login successfully', 'userdetails' => $user]);
                }
            } else {
                return response()->json(['status' => false, 'message' => 'Invalid username or password']);
            }
        }
    }

    public function forgotPassword(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'email' => 'required|email',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $row = User::where('role_id', 11)
                ->where('email', $request->email)
                ->first();
            if ($row) {
                $new_password = $this->randomOtp(10);
                $row->password = bcrypt($new_password);
                $row->save();
                $data = array(
                    "email" => $row->email,
                    "password" => $new_password,
                );
                $data['html'] = 'Yor updated password is: ' . $new_password;
                mailSend($data);
                return response()->json(['status' => true, 'message' => 'Your Password will be sent to your email address']);
            } else {
                return response()->json(['status' => false, 'message' => 'Invalid email']);
            }
        }
    }

    public function getProfile($user_id = null)
    {
        $row = User::where('role_id', 11)
            ->where('id', $user_id)
            ->first();
        if ($row) {
            $user = $this->getuserdetailfromObjectArray($row);
            return response()->json(['status' => true, 'message' => 'Profile fetch successfully', 'userdetails' => $user]);
        } else {
            return response()->json(['status' => false, 'message' => 'Invalid user']);
        }
    }


    public function updateProfile(Request $request)
    {
        $validator = Validator::make($request->all(), [

            'user_id' => 'required',
            'profile_pic' => 'mimes:jpeg,jpg,png',
            'name' => 'required|max:255',
            'email' => 'required|email|unique:users,email,' . $request->user_id,
            //'dob'=>'required',
            'phone_number' => 'required|numeric|unique:users,phone_number,' . $request->user_id,
            // 'gender'=>'required',
            'nationality' => 'required',


        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {

            $row = User::whereId($request->user_id)->first();
            $previous_row = $row;
            $row->name = $request->name;
            $row->email = $request->email;
            $row->gender = $request->gender;
            $row->nationality = $request->nationality;
            $row->phone_number = $request->phone_number;
            if (isset($request->dob) && $request->dob != '') {
                $row->dob = convertDMYtoYMD($request->dob);
            }

            if (isset($request->gender) && $request->gender != '') {
                $row->gender = $request->gender;
            }


            if ($request->file('profile_pic')) {
                $file = $request->file('profile_pic');
                $image = uploadwithresize($file, 'users', '186');
                if ($previous_row->image) {
                    unlinkfile('users', $previous_row->image);
                }
                $row->image = $image;
            }

            $row->save();


            $user = $user = $this->getuserdetailfromObjectArray($row);
            return response()->json(['status' => true, 'message' => 'profile updated successfully', 'userdetails' => $user]);
        }
    }


    public function logout(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'device_type' => 'required',
            'device_id' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $this->manageDeviceIdAndToken($request->user_id, $request->device_id, $request->device_type, 'delete');
            return response()->json(['status' => true, 'message' => 'Logout successfully']);
        }
    }


    public function changePassword(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'currentPassword' => 'required',
            'newPassword' => 'required'

        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $row = User::whereId($request->user_id)->first();
            if (Hash::check($request->currentPassword, $row->password)) {
                $row->password = bcrypt($request->newPassword);
                $row->save();

                return response()->json(['status' => true, 'message' => 'Password changed successfully']);
            } else {
                return response()->json(['status' => false, 'message' => 'Old password is not correct']);
            }
        }
    }


    public function manageDeviceIdAndToken($user_id, $device_id, $device_type, $methodName)
    {
        if ($methodName == 'add') {
            UserDevice::updateOrCreate(
                ['user_id' => $user_id, 'device_id' => $device_id, 'device_type' => $device_type]
            );
        }
        if ($methodName == 'delete') {
            UserDevice::where('user_id', $user_id)
                ->where('device_id', $device_id)
                ->where('device_type', $device_type)
                ->delete();
        }
    }

    public function deleteDeviceTokenForAllUser($device_id)
    {
        UserDevice::where('device_id', $device_id)
            ->delete();
    }

    public function loginPrintClassUser(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'username' => 'required',
            'password' => 'required',

        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $user_name = $request->username;
            $password = bcrypt($request->password);
            $row = PrintClassUser::where('username', $user_name)->first();
            if ($row && Hash::check($request->password, $row->password)) {
                //$user =  $this->getuserdetailfromObjectArray($row);
                $print_class_data = PrintClass::where('id', $row->print_class_id)->first();
                $print_class_name = $print_class_data->name;
                $user = (object)[
                    'print_class_user_id' => $row->id,
                    'name' => $row->name,
                    'username' => $row->username,
                    'restaurant_id' => $row->restaurant_id,
                    'print_class_name' => $print_class_name,

                    'print_class_id' => $row->print_class_id
                ];
                $user->name = $row->name;
                $user->username = $row->username;
                $user->restaurant_id = $row->restaurant_id;
                $user->print_class_id = $row->print_class_id;
                return response()->json(['status' => true, 'message' => 'login successfully', 'userdetails' => $user]);
            } else {
                return response()->json(['status' => false, 'message' => 'Invalid username or password']);
            }
        }
    }


    public function getcolorBystatus($status)
    {
        $status_color = ['NEW' => 'red', 'PREPARATION' => 'orange', 'READY TO PICK' => 'blue', 'DELIVERED' => 'green'];
        return $status_color[$status];
    }


    public function getOrderedItemHistoryByRestroAndPrintClass($restaurant_id, $print_class_id, $print_class_user_id)
    {
        $orderdetail = [];
        $order_arr = OrderedItem::where('restaurant_id', $restaurant_id)
            ->where('print_class_id', $print_class_id)
            ->whereNotIn('item_delivery_status', ['DELIVERED', 'PENDING', 'CANCLED', 'COMPLETED'])
            ->pluck('order_id')->toArray();

        $order_arr = array_unique($order_arr);
        $print_class_user = PrintClassUser::where('id', $print_class_user_id)->first();
        foreach ($order_arr as $order) {
            $order_data = Order::where('id', $order)->first();

            $can_cancle_item = 'no';
            $can_print_bill = 'no';
            $can_print_docket = 'yes';
            $current_status = OrderedItem::where('restaurant_id', $restaurant_id)
                ->where('print_class_id', $print_class_id)
                ->where('order_id', $order)
                ->first();

            $ordered_item_arr = OrderedItem::where('restaurant_id', $restaurant_id)
                ->where('print_class_id', $print_class_id)
                ->whereNotIn('item_delivery_status', ['DELIVERED', 'PENDING', 'CANCLED', 'COMPLETED'])
                ->where('order_id', $order)
                ->get();

            if ($print_class_user->can_cancle_item == '1' && $current_status->item_delivery_status == 'NEW' && $order_data->order_type == 'POSTPAID') {
                $can_cancle_item = 'yes';
            }

            if ($print_class_user->can_print_bill == '1') {
                $can_print_bill = 'yes';
            }


            $print_class_id = $print_class_user->print_class_id;
            $status_setting = $this->getPrintClassSetting();
            $total_count = HistoryPrintDocket::where('print_class_id', $print_class_id)->where('order_id', $order_data->id)->count();
            if ($total_count == '1') {
                if ($status_setting[$print_class_id]['can_print'] == 'no') {
                    $can_print_docket = 'no';
                }
            }

            $inner_array = [
                'date_and_time' => date('Y-m-d h:i A', strtotime($order_data->created_at)),
                'order_number' => $order_data->id,
                'table_number' => getAssociateTableWithOrder($order_data),
                'number_of_guest' => $order_data->total_guests,
                'waiter' => getAssociateWaiteWithOrder($order_data),
                'status' => $current_status->item_delivery_status,
                'status_color' => $this->getcolorBystatus($current_status->item_delivery_status),
                'can_cancle_item' => $can_cancle_item,
                'can_print_bill' => $can_print_bill,
                'can_print_docket' => $can_print_docket

            ];


            $condiments = [];
            $item_desc_array = [];
            foreach ($ordered_item_arr as $ordered_item) {
                $condiment_arr = json_decode($ordered_item->condiments_json);
                $item_desc = 'Item: ' . $ordered_item->item_title;
                if ($ordered_item->item_comment && $ordered_item->item_comment != "") {
                    $item_desc .= '(' . $ordered_item->item_comment . ')';
                }
                $item_desc .= '<br>Qty: ' . $ordered_item->item_quantity;
                $item_desc_array[] = $item_desc;


                if ($condiment_arr && count($condiment_arr) > 0) {

                    foreach ($condiment_arr as $condiment_data) {
                        if ($condiment_data->sub_items && count($condiment_data->sub_items) > 0) {
                            foreach ($condiment_data->sub_items as $sub_items) {
                                if ($sub_items->title) {
                                    $condiments[] = ucfirst($sub_items->title);
                                }
                            }
                        }
                    }
                }
            }

            $inner_array['item_desc_array'] = implode(' ,<br>', $item_desc_array);
            $inner_array['condiments'] = implode(' ,', $condiments);

            $orderdetail[] = $inner_array;
        }

        return $orderdetail;
    }

    public function getOrderedItemForPrintClassUsers(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'restaurant_id' => 'required',
            'print_class_id' => 'required',
            'print_class_user_id' => 'required'

        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $orderdetail = $this->getOrderedItemHistoryByRestroAndPrintClass($request->restaurant_id, $request->print_class_id, $request->print_class_user_id);
            return response()->json(['status' => true, 'message' => 'Order Items', 'orderdetail' => $orderdetail]);
        }
    }


    public function cancleItemsFromOrder(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'ordered_id' => 'required',
            'print_class_id' => 'required',


        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $order_id = $request->ordered_id;
            $print_class_id = $request->print_class_id;
            OrderedItem::where('order_id', $order_id)->where('print_class_id', $print_class_id)->update(['item_delivery_status' => 'CANCLED']);
            $is_have_another_data = OrderedItem::where('order_id', $order_id)->where('item_delivery_status', '!=', 'CANCLED')->first();
            if (!$is_have_another_data) {
                Order::where('id', $order_id)->update(['status' => 'CANCLED']);
            }
            return response()->json(['status' => true, 'message' => 'Item cancled successfully']);
        }
    }


    public function updateOrderedItemStatus(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'ordered_id' => 'required',
            'current_status' => 'required',
            'print_class_id' => 'required',

        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $order_id = $request->ordered_id;
            $print_class_id = $request->print_class_id;
            $current_status = $request->current_status;
            if ($current_status == 'NEW') {
                $update_status = 'PREPARATION';
                $this->createNotification('READYTOPREPAIR', ['order_id' => $order_id, 'updated_at' => date('Y-m-d H:i:s')]);
            }

            if ($current_status == 'PREPARATION') {
                $update_status = 'READY TO PICK';
                $this->createNotification('READYTOPICK', ['order_id' => $order_id, 'updated_at' => date('Y-m-d H:i:s')]);
            }
            if ($current_status == 'READY TO PICK') {
                $update_status = 'DELIVERED';
                //  $this->updateManageStockMoves($order_id);
            }
            DB::table('ordered_items')->where('print_class_id', $print_class_id)
                ->where('order_id', $order_id)
                ->update(['item_delivery_status' => $update_status]);

            if (isset($update_status)) {
                $current_data = [
                    'status' => $update_status,
                    'status_color' => $this->getcolorBystatus($update_status)
                ];
                return response()->json(['status' => true, 'message' => 'Status updated', 'new_status' => $current_data]);
            } else {
                return response()->json(['status' => false, 'message' => 'You have marked delivered']);
            }
        }
    }

    protected function updateManageStockMoves($order_id)
    {
        $order = Order::with('getAssociateItemWithOrder.getAssociateFooditem', 'getAssociateItemWithOrder.getAssociateFooditem.getAssociateRecipe.getAssociateIngredient.getAssociateItemDetail')
            ->where('id', $order_id)
            ->first();

        $order_items = $order->getAssociateItemWithOrder;
        foreach ($order_items as $order_item_key => $order_item_row) {

            if ($order_item_row->getAssociateFooditem->getAssociateRecipe) {
                $recipe_row = $order_item_row->getAssociateFooditem->getAssociateRecipe;
                $wa_location_and_store_id = $recipe_row->wa_location_and_store_id;
                $recipe_ingredients = $order_item_row->getAssociateFooditem->getAssociateRecipe->getAssociateIngredient;
                foreach ($recipe_ingredients as $key => $recipe_ingredient_row) {
                    $series_module = WaNumerSeriesCode::where('module', 'GRN')->first();
                    $dateTime = date('Y-m-d H:i:s');

                    $inventory_item_row = $recipe_ingredient_row->getAssociateItemDetail;
                    $inventory_qoh = getItemAvailableQuantity($inventory_item_row->stock_id_code, $wa_location_and_store_id);
                    $weight = $recipe_ingredient_row->weight;
                    if ($weight > $inventory_qoh) {
                        $deficient_quantity = $weight - $inventory_qoh;
                        $sold_but_unbooked_entity = new WaSoldButUnbookedItem();
                        $sold_but_unbooked_entity->order_id = $order->id;
                        $sold_but_unbooked_entity->wa_recipe_ingredient_id = $recipe_ingredient_row->id;
                        $sold_but_unbooked_entity->ordered_item_id = $order_item_row->id;
                        $sold_but_unbooked_entity->wa_inventory_item_id = $inventory_item_row->id;
                        $sold_but_unbooked_entity->qoh = $inventory_qoh;
                        $sold_but_unbooked_entity->deficient_quantity = $deficient_quantity;
                        $sold_but_unbooked_entity->save();
                        $weight = $inventory_qoh;
                    }
                    if ($weight > 0 && $weight >= $inventory_qoh) {
                        $stockMove = new WaStockMove();
                        $stockMove->user_id = $order->user_id;
                        $stockMove->ordered_item_id = $order_item_row->id;
                        $stockMove->restaurant_id = $order_item_row->restaurant_id;
                        $stockMove->wa_location_and_store_id = $wa_location_and_store_id;
                        $stockMove->wa_inventory_item_id = $inventory_item_row->id;
                        $stockMove->standard_cost = $inventory_item_row->standard_cost;
                        $stockMove->qauntity = -($weight);
                        $stockMove->new_qoh = $inventory_qoh; //@$inventory_item_row->getAllFromStockMoves->where('wa_location_and_store_id',$wa_location_and_store_id)->sum('qauntity') - ($weight);
                        $stockMove->stock_id_code = $inventory_item_row->stock_id_code;
                        $stockMove->grn_type_number = $series_module->type_number;
                        $stockMove->grn_last_nuber_used = $series_module->last_number_used;
                        $stockMove->price = $inventory_item_row->standard_cost;
                        $stockMove->refrence = $order->slug;
                        $stockMove->save();
                    }
                }
            }
        }
        return;
    }

    public function getOrderItemCondimentDetail($order)
    {
        $condiment = [];
        $condiment_arr = json_decode($order->condiments_json);
        if ($condiment_arr && count($condiment_arr) > 0) {

            foreach ($condiment_arr as $condiment_data) {
                if ($condiment_data->sub_items && count($condiment_data->sub_items) > 0) {
                    foreach ($condiment_data->sub_items as $sub_items) {
                        if ($sub_items->title) {
                            $condiment[] = ucfirst($sub_items->title);
                        }
                    }
                }
            }
        }
        return implode(' ,', $condiment);
    }

    public function getValidateComplimentaryAmountWithCode(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'complimentry_code' => 'required',
            'order_final_price' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $complimentry_code = $request->complimentry_code;
            $order_final_price = $request->order_final_price;

            $is_exist = User::where('complementary_number', $complimentry_code)->first();
            if ($is_exist) {
                $currentMonth = date('m');
                $currentMonthSpentAmountWithComplementaryCode = Order::where('complimentry_code', $complimentry_code)
                    ->whereRaw('MONTH(created_at) = ?', [$currentMonth])
                    ->whereNotIn('status', ['CANCLED', 'PENDING'])
                    ->sum('order_final_price');
                $canOrderWithLeftPriceAmount = $is_exist->complementary_amount - $currentMonthSpentAmountWithComplementaryCode;
                if ($order_final_price <= $canOrderWithLeftPriceAmount) {
                    //can make order with complementary amount
                    return response()->json(['status' => true, 'message' => 'Can purchase']);
                } else {
                    //limit exceed
                    return response()->json(['status' => false, 'message' => 'Complementary number limit exceed for this month']);
                }
            } else {
                return response()->json(['status' => false, 'message' => 'Invalid complementary number']);
            }
        }
    }

    public function getFeedbackStatus($id, $rating_for)
    {
        $status = 'PENDING';
        if ($rating_for == 'O') {
            $row = Feedback::where('order_id', $id)->first();
            if ($row) {
                $status = $row->status == 'N' ? 'SKIPED' : 'COMPLETED';
            }
        }
        if ($rating_for == 'R') {
            $row = Feedback::where('restaurant_id', $id)->first();
            if ($row) {
                $status = $row->status == 'N' ? 'SKIPED' : 'COMPLETED';
            }
        }
        return $status;
    }

    public function getMyOrders(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',

        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $all_orders = Order::where('user_id', $request->user_id)
                // ->where('restaurant_id',$request->restaurant_id)
                ->whereNotIn('status', ['CANCLED', 'PENDING'])
                ->orderBy('id', 'desc')
                ->get();
            $all_orders_listing = [];
            foreach ($all_orders as $order) {
                $waiters = getAssociateWaiterIdsWithOrder($order);
                $waiter_id = '';
                if (count($waiters) > 0) {
                    $waiter_id = $waiters[0];
                }
                $inner_array = [
                    'order_id' => $order->id,
                    'waiter_id' => $waiter_id,
                    'order_total_price' => $order->order_final_price,
                    'feedback_status' => $this->getFeedbackStatus($order->id, 'O'),
                    'is_tip_given' => $this->isTipGiven($order->id),
                    'order_is_completed' => $order->status == 'COMPLETED' ? true : false,
                    'order_created_time' => date('h:i A', strtotime($order->created_at)),
                    'order_created_date' => date('Y-m-d', strtotime($order->created_at)),
                    'order_created_timestr' => strtotime($order->created_at),
                    'items' => [],
                    'offer_data' => []
                ];
                $ordered_item = $order->getAssociateItemWithOrder;
                $counter = 0;
                foreach ($ordered_item as $item) {
                    if ($item->item_delivery_status != 'CANCLED' && !$item->order_offer_id) {

                        $item_detail = $item->getAssociateFooditem;
                        $inner_array['items'][$counter]['title'] = $item_detail->name;
                        $inner_array['items'][$counter]['item_id'] = $item_detail->id;
                        $inner_array['items'][$counter]['quantity'] = $item->item_quantity;
                        $inner_array['items'][$counter]['price'] = $item->price;
                        $inner_array['items'][$counter]['comment'] = isset($item->item_comment) ? $item->item_comment : '';
                        $inner_array['items'][$counter]['image'] = $item_detail->image ? $this->uploadsfolder . '/menu_items/thumb/' . $item_detail->image : $this->uploadsfolder . '/item_none.png';
                        $inner_array['items'][$counter]['condiments'] = [];
                        $condiments_json_arr = json_decode($item->condiments_json);
                        if (count($condiments_json_arr) > 0) {
                            foreach ($condiments_json_arr as $cn) {
                                if (count($cn->sub_items) > 0) {
                                    foreach ($cn->sub_items as $condiment_item) {

                                        $inner_array['items'][$counter]['condiments'][] = ucfirst($condiment_item->title);
                                    }
                                }
                            }
                        }
                        $counter++;
                    }
                }


                $ordered_offers = $order->getAssociateOffersWithOrder;
                foreach ($ordered_offers as $offers) {
                    $is_exist = OrderedItem::where('order_offer_id', $offers->id)
                        ->whereNotIn('item_delivery_status', ['CANCLED', 'PENDING'])
                        ->first();
                    if ($is_exist) {
                        $single_offer = [
                            'offer_title' => $offers->offer_title,
                            'offer_quantity' => $offers->quantity,
                            'offer_price' => $offers->price,
                            'offer_image' => $offers->getAssociateOffersDetail->image ? $this->uploadsfolder . '/menu_item_groups/thumb/' . $offers->getAssociateOffersDetail->image : $this->uploadsfolder . '/item_none.png',


                        ];
                        $inner_array['offer_data'][] = $single_offer;
                    }
                }
                $all_orders_listing[] = $inner_array;
            }
            return response()->json([
                'status' => true,
                'message' => 'My orders listing',
                'listings' => $all_orders_listing,
                'pending_order_count' => $this->getPendingorderCount($request->user_id),
                'loyalty_points' => $this->getLoyaltyPointsByUserId($request->user_id)

            ]);
        }
    }

    public function getAllWaiterRelatedToOrder(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'order_id' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $order = Order::where('id', $request->order_id)->first();
            if ($order) {
                $waiter_arr = [];
                $all_tables_arr = $order->getAssociateTableWithOrder()->pluck('table_id')->toArray();
                if (count($all_tables_arr)) {
                    $waiter_ids_arr = EmployeeTableAssignment::whereIn('table_manager_id', $all_tables_arr)->pluck('user_id')->toArray();
                    if (count($waiter_ids_arr) > 0) {
                        $waiters = User::whereIn('id', $waiter_ids_arr)->get();
                        $counter = 0;
                        foreach ($waiters as $waiter) {
                            $waiter_arr[$counter]['waiter_id'] = $waiter->id;
                            $waiter_arr[$counter]['name'] = ucfirst($waiter->name);
                            $waiter_arr[$counter]['badge_number'] = $waiter->badge_number;
                            $waiter_arr[$counter]['id_number'] = $waiter->id_number;
                            $waiter_arr[$counter]['image'] = $waiter->image ? $this->uploadsfolder . '/users/thumb/' . $waiter->image : $this->uploadsfolder . '/item_none.png';
                            $counter++;
                        }
                    }
                }
                return response()->json(['status' => true, 'message' => 'Waiter Listings', 'listings' => $waiter_arr]);
            } else {
                return response()->json(['status' => false, 'message' => 'Invalid order']);
            }
        }
    }


    public function addCommentOnBill(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'bill_narration' => 'required',
            'bill_id' => 'required',
            'user_id' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            Bill::where('id', $request->bill_id)->where('user_id', $request->user_id)->update(['bill_narration' => $request->bill_narration]);
            return response()->json(['status' => true, 'message' => 'Comment added successfully']);
        }
    }


    public function addWaiterTip(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'order_id' => 'required',
            'tip_amount' => 'required',
            'payment_mode' => 'required',
            'waiter_id' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $tip = new WaiterTip();
            $tip->waiter_id = $request->waiter_id;
            $tip->tip_amount = $request->tip_amount;
            $tip->payment_mode = $request->payment_mode;
            $tip->order_id = $request->order_id;

            if (isset($request->mpesa_request_id)) {
                $tip->mpesa_request_id = $request->mpesa_request_id;
            }
            $tip->save();
            return response()->json(['status' => true, 'message' => 'Tip added successfully']);
        }
    }

    public function getLoyaltyPoint($user_id = null)
    {
        $row = LoyaltyPoint::with('order')
            ->select('order_id', 'points', 'points_source', 'status', DB::raw('DATE_FORMAT(created_at, "%d-%m-%Y") as Date'))
            ->where('user_id', $user_id)
            ->orderBy('id', 'DESC')
            ->get();


        // $total = array_sum($row->pluck('points')->toArray());

        $total = $this->getLoyaltyPointsByUserId($user_id);
        if ($row) {
            return response()->json(['status' => true, 'message' => 'User Loyalty Points fetch successfully', 'LoyaltyPoints' => $row, 'totalpoints' => $total]);
        } else {
            return response()->json(['status' => false, 'message' => 'Invalid user']);
        }
    }

    public function printbillForOrder(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'ordered_id' => 'required',
            'print_class_user_id' => 'required',
            'print_type' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {

            $print_class_user_info = PrintClassUser::where('id', $request->print_class_user_id)->first();
            $print_class_id = $print_class_user_info->print_class_id;
            $historyPrintDocket = new HistoryPrintDocket();
            $historyPrintDocket->order_id = $request->ordered_id;
            $historyPrintDocket->print_class_id = $print_class_id;
            $historyPrintDocket->save();
            //                echo "done"; die;
            //echo "<pre>"; print_r($print_class_user_info); die();
            $receipt = printBill($request->print_class_user_id, $request->ordered_id, $request->print_type, 'P');

            return $receipt;
        }
    }

    public function getPrintClassSetting()
    {
        $all_print_class = PrintClass::get();
        $status_setting = [];
        foreach ($all_print_class as $print_class_data) {
            $status_setting[$print_class_data->id]['status'] = $print_class_data->jump_to_status;
            $status_setting[$print_class_data->id]['can_print'] = 'yes';
            if ($print_class_data->can_multiple_print == '0') {
                $status_setting[$print_class_data->id]['can_print'] = 'no';
            }
        }
        return $status_setting;
    }


    public function managedocketstatus(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'ordered_id' => 'required',
            'print_class_user_id' => 'required'

        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $print_class_user_info = PrintClassUser::where('id', $request->print_class_user_id)->first();
            $print_class_id = $print_class_user_info->print_class_id;
            $data = ['status_changed' => false];
            $total_count = HistoryPrintDocket::where('print_class_id', $print_class_id)->where('order_id', $request->ordered_id)->count();
            if ($total_count == '1') {
                $order_item = OrderedItem::where('order_id', $request->ordered_id)->where('print_class_id', $print_class_id)->first();


                if ($order_item->item_delivery_status == 'NEW' || $order_item->item_delivery_status == 'PREPARATION') {

                    $status_setting = $this->getPrintClassSetting();


                    $changed_status = $status_setting[$print_class_id]['status'];
                    $can_print = $status_setting[$print_class_id]['can_print'];
                    $status_color = $this->getcolorBystatus($changed_status);

                    $order_item = OrderedItem::where('order_id', $request->ordered_id)->where('print_class_id', $print_class_id)->update(['item_delivery_status' => $changed_status]);
                    if ($changed_status == 'PREPARATION') {
                        $this->createNotification('READYTOPREPAIR', ['order_id' => $request->ordered_id, 'updated_at' => date('Y-m-d H:i:s')]);
                    }

                    if ($changed_status == 'READY TO PICK') {
                        $this->createNotification('READYTOPICK', ['order_id' => $request->ordered_id, 'updated_at' => date('Y-m-d H:i:s')]);
                    }


                    $data = ['status_changed' => true, 'changed_status' => $changed_status, 'can_print' => $can_print, 'status_color' => $status_color];
                }
            }
            return response()->json(['status' => true, 'message' => 'settings', 'data' => $data]);
        }
    }


    public function distance($lat1, $lon1, $lat2, $lon2, $unit)
    {
        /***********************************************************************************************
         * function for get the distance between two coordinates
         * $unit = K(kilometer),M(Miles),N(Natural miles)
         ***********************************************************************************************/
        //echo $lat1.'=='.$lon1.'=='.$lat2.'=='.$lon2.'=='.$unit; die;
        $theta = $lon1 - $lon2;
        $dist = sin(deg2rad($lat1)) * sin(deg2rad($lat2)) + cos(deg2rad($lat1)) * cos(deg2rad($lat2)) * cos(deg2rad($theta));
        $dist = acos($dist);
        $dist = rad2deg($dist);
        $miles = $dist * 60 * 1.1515;
        $unit = strtoupper($unit);

        if ($unit == "K") {
            return round(($miles * 1.609344), 2) . ' Km away';
        } else if ($unit == "N") {
            return ($miles * 0.8684);
        } else {
            return $miles;
        }
    }


    public function loginDjUser(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'username' => 'required',
            'password' => 'required',

        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $user_name = $request->username;
            $password = bcrypt($request->password);


            $row = User::where('role_id', 100)
                ->where('status', '1')
                ->where(function ($query) use ($user_name) {
                    $query->where('email', $user_name);
                    $query->orWhere('phone_number', $user_name);
                })
                ->first();
            if ($row && Hash::check($request->password, $row->password) && $row->status == '1') {
                $user = (object)[
                    'user_id' => $row->id,
                    'name' => $row->name,

                    'restaurant_id' => $row->restaurant_id

                ];
                return response()->json(['status' => true, 'message' => 'login successfully', 'userdetails' => $user]);
            } else {
                return response()->json(['status' => false, 'message' => 'Invalid username or password']);
            }
        }
    }


    public function updateDjRequestStatus(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'request_id' => 'required',
            'current_status' => 'required',

        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $row = DjRequest::where('id', $request->request_id)->first();

            if ($row) {
                $row->status = 'COMPLETED';
                $row->save();
            }

            $data = ['status' => 'COMPLETED', 'status_color' => 'red'];
            return response()->json(['status' => true, 'message' => 'Status updated successfully', 'data' => $data]);
        }
    }

    public function getNewResquestFroDj(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'restaurant_id' => 'required',

        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $data = [];
            $i = 0;
            $restaurant_id = $request->restaurant_id;
            $all_request = DjRequest::where('restaurant_id', $restaurant_id)->whereIn('status', ['NEW'])->get();
            foreach ($all_request as $my_request) {
                $data[$i]['request_id'] = $my_request->id;
                $data[$i]['date_and_time'] = date('Y-m-d h:i A', strtotime($my_request->created_at));
                $data[$i]['comment'] = $my_request->comment;
                $data[$i]['user_name'] = $my_request->getAssociateUser->name;
                $data[$i]['status'] = $my_request->status;
                $data[$i]['status_color'] = $my_request->status == 'NEW' ? 'green' : 'red';
                $i++;
            }
            return response()->json(['status' => true, 'message' => 'listing', 'data' => $data]);
        }
    }

    public function makeDjRequest(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'restaurant_id' => 'required',
            'comment' => 'required',

        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $new_request = new DjRequest();
            $new_request->comment = $request->comment;
            $new_request->user_id = $request->user_id;
            $new_request->restaurant_id = $request->restaurant_id;
            $new_request->save();
            return response()->json(['status' => true, 'message' => 'Your request added successfully', 'request_id' => $new_request->id]);
        }
    }


    public function getRestaurantFloorPlans()
    {
        $rows = Restaurant::get();
        $all_floor_plans = [];
        $i = 0;
        foreach ($rows as $row) {
            $all_floor_plans[$i]['restaurant_id'] = $row->id;
            $all_floor_plans[$i]['restaurant_floor_image'] = $this->uploadsfolder . '/restaurants/' . $row->floor_image;
            $all_floor_plans[$i]['restaurant_floor_image_thumb'] = $this->uploadsfolder . '/restaurants/thumb/' . $row->floor_image;

            $all_floor_plans[$i]['restaurant_name'] = $row->name;
            $all_floor_plans[$i]['restaurant_location'] = $row->location;
            $i++;
        }
        return response()->json(['status' => true, 'message' => 'Restaurant list with floor plan', 'data' => $all_floor_plans]);
    }

    public function addReservationrequest(Request $request)
    {
        ignore_user_abort(true);
        set_time_limit(0);
        ob_start();
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'restaurant_id' => 'required',

            'reservation_time' => 'required',
            'comment' => 'max:250',
            'phone_number' => 'required',
            'email' => 'required|email',

            'event_type' => 'required|max:250',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {

            $row = new Reservation();
            $row->user_id = $request->user_id;
            $row->restaurant_id = $request->restaurant_id;

            $row->reservation_time = date('Y-m-d H:i:s', strtotime($request->reservation_time));
            $row->comment = $request->comment ? $request->comment : null;
            $row->phone_number = $request->phone_number;
            $row->email = $request->email;

            $row->event_type = $request->event_type;
            $row->save();


            $reservation_data = Reservation::where('id', $row->id)->first();


            // This code use for notification message send response return speedly.


            echo json_encode(["status" => true, "message" => 'Reservation Booking successfull']);
            header("Content-Encoding: none");
            header('Connection: close');
            header('Content-Length: ' . ob_get_length());
            ob_end_flush();
            ob_flush();
            flush();
            session_write_close();


            $all_reservation_emails = ReservationEmail::select('email', 'phone_number')->get();


            //$admin_email_arr = ["events@thebigfivebreweries.com","sales@thebigfivebreweries.com","info@thebigfivebreweries.com"];

            //$admin_email_arr = array();
            // foreach($all_reservation_emails as $getemail)
            // {
            //
            //}


            foreach ($all_reservation_emails as $arr_email) {


                $this->sendReservationEmail($arr_email->email, 'admin', $reservation_data);
                if ($arr_email->phone_number && $arr_email->phone_number != '') {
                    $this->sendMessageOnMobileNumber($arr_email->phone_number, 'You have got a new reservation request');
                }
            }


            $this->sendReservationEmail($row->email, 'user', $reservation_data);
        }
    }

    public function sendReservationEmail($mail_address, $user_type, $row)
    {
        $data['send_to'] = $mail_address;
        $data['restro_name'] = $row->getAssociateRestro->name;
        $data['name'] = $row->getAssociateUser->name;
        $data['no_of_person'] = $row->no_of_person;
        $data['event_type'] = $row->event_type;
        $data['time'] = date('d-m-Y h:i A', strtotime($row->reservation_time));


        $data['subject'] = 'Reservation request';


        if ($user_type == 'user') {
            $data['subject'] = 'Your booking at Restaurant is pending.';
            reservationEmailSend('emails.user_reservation', $data);
        } else if ($user_type == 'admin') {
            reservationEmailSend('emails.admin_reservation', $data);
        } else {
        }
    }

    /***********************************************************************************************
     * After Manager Login ( Ranjeet Giri)
     ***********************************************************************************************/

    public function daily_sales_summary(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'from_date' => 'nullable|date',
            'to_date' => 'nullable|date',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        }
        $all_item = \App\Model\WaStockMove::select([
            'stock_id_code',
            'standard_cost',
            \DB::RAW('(select title from wa_inventory_items where wa_inventory_items.id = wa_stock_moves.wa_inventory_item_id limit 1) as item_description'),
            \DB::RAW('SUM(qauntity) as item_sold'),
            \DB::RAW('SUM(qauntity*price) as to_get_avg'),
        ])->where('user_id', $request->user_id)->where('qauntity', '<', 0)->where('stock_adjustment_id', null);
        if ($request->has('from_date')) {
            $request->from_date = date('Y-m-d', strtotime($request->from_date));
            if ($request->from_date != date('Y-m-d')) {
                $request->from_date = date('Y-m-d', strtotime('+1 days ' . $request->from_date));
            }
            $all_item = $all_item->whereDate('created_at', '>=', $request->from_date);
        } else {
            $all_item = $all_item->whereDate('created_at', '>=', date('Y-m-d'));
        }
        if ($request->has('to_date')) {
            $request->to_date = date('Y-m-d', strtotime($request->to_date));
            if ($request->to_date != date('Y-m-d')) {
                $request->to_date = date('Y-m-d', strtotime('+1 days ' . $request->to_date));
            }
            $all_item = $all_item->whereDate('created_at', '<=', $request->to_date);
        } else {
            $all_item = $all_item->whereDate('created_at', '<=', date('Y-m-d'));
        }
        $all_item = $all_item->groupBy('stock_id_code')->orderBy('stock_id_code', 'ASC')->get();
        $data = [];

        foreach ($all_item as $item) {
            $data[] = [
                'stock_id_code' => $item->stock_id_code,
                'item_description' => $item->item_description,
                'standard_cost' => $item->standard_cost,
                'item_sold' => abs($item->item_sold),
                'avg_price' => round(((abs($item->item_sold) > 0) ? abs($item->to_get_avg) / abs($item->item_sold) : 0), 2),
                'total' => round((abs($item->item_sold) * ((abs($item->item_sold) > 0) ? abs($item->to_get_avg) / abs($item->item_sold) : 0)), 2)
            ];
        }
        return response()->json(['status' => true, 'message' => 'Daily Sales Summary API', 'data' => $data]);
    }

    public function daily_summary(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'from_date' => 'nullable|date',
            'to_date' => 'nullable|date',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        }

        $getUserData = User::where('id', $request->user_id)->first();
        if ($request->from_date) {
            $where = " AND (DATE(wa_stock_moves.created_at) BETWEEN '" . $request->from_date . "' AND '" . $request->to_date . "')";
        } else {
            $where = " AND DATE(wa_stock_moves.created_at) = '" . date('Y-m-d') . "'";
        }
        $where .= " AND wa_stock_moves.user_id = '" . $request->user_id . "'";

        $data = WaInventoryItem::select(
            'id',
            'stock_id_code',
            'description',
            'standard_cost',
            'selling_price',
            'minimum_order_quantity',
            DB::raw("(SELECT SUM(`qauntity`) from `wa_stock_moves` where 
        `wa_stock_moves`.`stock_id_code` = `wa_inventory_items`.`stock_id_code` 
        " . $where . " AND qauntity < 0 AND `stock_adjustment_id` is not null) as totalQty")
        )
            ->having('totalQty', '<', 0)
            ->get()->map(function ($item) {
                if ($item->totalQty < 0) {
                    $item->totalQty = -($item->totalQty);
                }
                return $item;
            });
        return response()->json(['status' => true, 'message' => 'Daily Summary Report', 'data' => $data]);
    }

    public function dailySalesSummary(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $currentDate = date('Y-m-d', strtotime(' -1 day')) . " 08:00:00";
            $tomorrowDate = date('Y-m-d', strtotime(' +1 day')) . " 08:00:00";
            $lists = Bill::where('status', 'PENDING');
            $lists->where('created_at', '<=', $tomorrowDate);
            $lists->where('created_at', '>=', $currentDate);
            $lists = $lists->orderBy('id', 'desc')->get();
            $total_bill = [];
            foreach ($lists as $list) {
                foreach ($list->getAssociateOrdersWithBill as $single_order) {
                    $total_bill[] = $single_order->getAssociateOrderForBill->order_final_price;
                }
            }

            $closebillpayment = array_sum($total_bill);

            $posts = OrderReceipt::where('is_printed', '0')->whereDate('created_at', '>=', date('Y-m-d'))->get();
            $total_bill = [];
            foreach ($posts as $list) {
                foreach ($list->getAssociateOrdersWithReceipt as $single_order) {
                    $total_bill[] = $single_order->getAssociateOrderForReceipt->order_final_price;
                }
            }

            $closedOrderPayments = OrderReceipt::where('created_at', '>=', date('Y-m-d'))->get();
            foreach ($closedOrderPayments as $listing) {
                foreach ($listing->getAssociateOrdersWithReceipt as $single_order) {
                    $total_bill[] = $single_order->getAssociateOrderForReceipt->order_final_price;
                }
            }

            $CloseOrderPayments = array_sum($total_bill);

            $data['open_bills_total'] = $closebillpayment;
            $data['closed_orders_total'] = $CloseOrderPayments;
            $data['grand_total'] = $CloseOrderPayments + $closebillpayment;

            $response_array = ['status' => true, 'message' => 'Daily Sales Summary', 'data' => $data];
            return response()->json($response_array);
        }
    }


    public function MonthlySalesSummary(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {

            $sale_transaction_month = '07'; //date('m');
            $sale_transaction_year = '2020'; //date('Y');

            if ($request->has('sale_transaction_month')) {
                $sale_transaction_month = $request->input('sale_transaction_month');
            }

            if ($request->has('sale_transaction_year')) {
                $sale_transaction_year = $request->input('sale_transaction_year');
            }

            $sales_transaction_stats = $this->getSalesTransactionDetailsByMonth($sale_transaction_month, $sale_transaction_year);

            $response_array = ['status' => true, 'message' => 'Month Sales Summary', 'data' => $sales_transaction_stats];
            return response()->json($response_array);
        }
    }

    public function getSalesTransactionDetailsByMonth($month, $year)
    {
        $final_data = [];
        $rows = DB::select(DB::raw("
            SELECT MONTH(created_at) as created_day,sum(amount) as total_amount FROM `receipt_summary_payments` WHERE payment_mode != 'COMPLEMENTARY' AND YEAR(created_at)='" . $year . "' GROUP BY MONTH(created_at)"));
        foreach ($rows as $row) {
            $inner_array = [
                $row->created_day,
                round($row->total_amount, 2),
            ];
            $final_data[] = $inner_array;
        }
        return $final_data;
    }

    public function getSalesTransactionDetails($month, $year)
    {
        $final_data = [];
        $rows = DB::select(DB::raw("
            SELECT DAY(created_at) as created_day,sum(amount) as total_amount FROM `receipt_summary_payments` WHERE payment_mode != 'COMPLEMENTARY' AND created_at like '" . $year . "-" . $month . "%' GROUP BY DAY(created_at), MONTH(created_at),Year(created_at)"));
        foreach ($rows as $row) {
            $inner_array = [
                $row->created_day,
                round($row->total_amount, 2),
            ];
            $final_data[] = $inner_array;
        }
        return $final_data;
    }

    public function DashboardSalesSummary(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $data = $this->getTotalEarningStats();
            $response_array = ['status' => true, 'message' => 'Dashboard Sales Summary', 'data' => $data];
            return response()->json($response_array);
        }
    }


    public function getVoidBills(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {

            $lists = Bill::where('status', 'PENDING');
            $lists = $lists->orderBy('id', 'desc')->get();

            $data = [];

            foreach ($lists as $key => $val) {
                $data[$key]['bill_id'] = $val->id;
                $data[$key]['created_at'] = date('Y-m-d', strtotime($val->created_at));
                $data[$key]['waiter_name'] = ucfirst($val->getAssociateUserForBill->name);
                $totalorderamnt = 0;
                $data[$key]['slug'] = $val->slug;
                foreach ($val->getAssociateOrdersWithBill as $k => $single_order) {
                    $data[$key]['orders'][$k]['order_id'] = $single_order->order_id;
                    foreach ($single_order->getAssociateOrderForBill->getAssociateItemWithOrder as $j => $itemorder) {
                        $data[$key]['orders'][$k]['order_item'][$j] = $itemorder;
                    }
                    $totalorderamnt += $single_order->getAssociateOrderForBill->order_final_price;
                }
                $data[$key]['total_amount'] = $totalorderamnt;
            }

            $response_array = ['status' => true, 'message' => 'Void Bills List', 'data' => $data];
            return response()->json($response_array);
        }
    }

    public function voidItemsByBill(Request $request)
    {
        //echo "<pre>"; print_r($request->all()); die;
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'void_reason' => 'required',
            'from_bill_slug' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $slug = $request->get('from_bill_slug');
            if ((isset($request->ordered_item_id) && count($request->ordered_item_id) > 0) || (isset($request->ordered_offer_id) && count($request->ordered_offer_id) > 0)) {
                $fromBill = Bill::where('slug', $slug)->where('status', 'PENDING')->first();
                if ($fromBill) {
                    $firstOrderForToBill = $fromBill->getAssociateOrdersWithBill->first();
                    $firstOrderDetail = $firstOrderForToBill->getAssociateOrderForBill;
                    $table_id = $firstOrderDetail->getAssociateTableWithOrder->first()->table_id;
                    $table_assignment = EmployeeTableAssignment::where('table_manager_id', $table_id)->first();
                    if ($table_assignment) {
                        $user_id = $table_assignment->user_id;
                        $new_order = new Order();
                        $new_order->user_id = $user_id;
                        $new_order->restaurant_id = $firstOrderDetail->restaurant_id;
                        $new_order->final_comment = '';
                        $new_order->order_final_price = '0';
                        $new_order->slug = rand(99, 999) . strtotime(date('Y-m-d h:i:s'));
                        $new_order->order_type = 'POSTPAID';
                        $new_order->status = 'CANCLED';
                        $new_order->total_guests = 1;
                        $new_order->order_charges = null;
                        $new_order->payment_mode = 'NA';
                        $new_order->order_cancle_reason = $request->void_reason;
                        $new_order->order_canceled_by_user = $request->get('user_id'); //getLoggeduserProfile()->id;
                        $new_order->save();
                        $new_order_id = $new_order->id;
                        $inserting_array = [];
                        $inner_array = [
                            'order_id' => $new_order_id,
                            'table_id' => $table_id
                        ];
                        $inserting_array[] = $inner_array;
                        OrderBookedTable::insert($inserting_array);

                        if (isset($request->ordered_item_id) && count($request->ordered_item_id) > 0) {
                            //transfer orders item
                            $all_item_ids = array_keys($request->ordered_item_id);
                            $allOrdersForUpdate = [$new_order_id];
                            foreach ($all_item_ids as $ordered_item_id) {
                                $original = 'original_qty_' . $ordered_item_id;
                                $selected = 'selected_qty_' . $ordered_item_id;
                                $relatedOrderItem = OrderedItem::where('id', $ordered_item_id)->first();
                                $relatedOrderId = $relatedOrderItem->order_id;
                                $allOrdersForUpdate[] = $relatedOrderId;
                                if ($request->$original == $request->$selected) {
                                    OrderedItem::where('id', $ordered_item_id)->update(['order_id' => $new_order_id]);
                                } else {
                                    $oldOrderedItem = OrderedItem::where('id', $ordered_item_id)->first();
                                    //create new ordereditem
                                    $leftQuantity = $request->$original - $request->$selected;
                                    $newOrderItem = new OrderedItem();
                                    $newOrderItem->order_id = $new_order_id;
                                    $newOrderItem->food_item_id = $oldOrderedItem->food_item_id;
                                    $newOrderItem->order_offer_id = $oldOrderedItem->order_offer_id;
                                    $newOrderItem->restaurant_id = $oldOrderedItem->restaurant_id;
                                    $newOrderItem->price = $oldOrderedItem->price;
                                    $newOrderItem->item_title = $oldOrderedItem->item_title;
                                    $newOrderItem->item_comment = $oldOrderedItem->item_comment;
                                    $newOrderItem->item_quantity = $request->$selected;
                                    $newOrderItem->condiments_json = $oldOrderedItem->condiments_json;
                                    $newOrderItem->print_class_id = $oldOrderedItem->print_class_id;
                                    $newOrderItem->item_delivery_status = $oldOrderedItem->item_delivery_status;
                                    $newOrderItem->created_at = $oldOrderedItem->created_at;
                                    $newOrderItem->updated_at = $oldOrderedItem->updated_at;
                                    $newOrderItem->billing_time = $oldOrderedItem->billing_time;
                                    $oldOrderedItem_item_charges = json_decode($oldOrderedItem->item_charges);
                                    if (is_array($oldOrderedItem_item_charges) && count($oldOrderedItem_item_charges) > 0) {
                                        foreach ($oldOrderedItem_item_charges as $charges) {
                                            $charges_arr[strtoupper($charges->charges_name)]['charges_name'] = $charges->charges_name;
                                            $charges_arr[strtoupper($charges->charges_name)]['charges_value'] = $charges->charges_value;
                                            $charges_arr[strtoupper($charges->charges_name)]['charges_format'] = $charges->charges_format;
                                            $new_charges_arr[strtoupper($charges->charges_name)]['charges_name'] = $charges->charges_name;
                                            $new_charges_arr[strtoupper($charges->charges_name)]['charges_value'] = $charges->charges_value;
                                            $new_charges_arr[strtoupper($charges->charges_name)]['charges_format'] = $charges->charges_format;
                                            if (isset($charges_arr[strtoupper($charges->charges_name)]['charged_amount'])) {
                                                $spillted_chared_amount = $charges->charged_amount / $request->$original;
                                                $new_amount = $spillted_chared_amount * $request->$selected;
                                                $charges_arr[strtoupper($charges->charges_name)]['charged_amount'] = $charges_arr[strtoupper($charges->charges_name)]['charged_amount'] + $new_amount;

                                                $newCgareAmount = $spillted_chared_amount * $leftQuantity;
                                                $new_charges_arr[strtoupper($charges->charges_name)]['charged_amount'] = $new_charges_arr[strtoupper($charges->charges_name)]['charged_amount'] + $newCgareAmount;
                                            } else {
                                                $spillted_chared_amount = $charges->charged_amount / $request->$original;
                                                $new_amount = $spillted_chared_amount * $request->$selected;
                                                $charges_arr[strtoupper($charges->charges_name)]['charged_amount'] = $new_amount;

                                                $newCgareAmount = $spillted_chared_amount * $leftQuantity;

                                                $new_charges_arr[strtoupper($charges->charges_name)]['charged_amount'] = $newCgareAmount;
                                            }
                                        }
                                        $newOrderItem->item_charges = json_encode(array_values($charges_arr));
                                        $oldOrderedItem->item_charges = json_encode(array_values($new_charges_arr));
                                    }
                                    $oldOrderedItem->item_quantity = $leftQuantity;
                                    $oldOrderedItem->save();
                                    $newOrderItem->save();
                                }
                            }
                            $this->updateOrderStatsAfterTransfer($allOrdersForUpdate);
                            $this->manageFromBill($fromBill->id);

                            $response_array['status'] = true;
                            $response_array['message'] = "Item moved to void successfully";
                        }
                    } else {
                        $response_array['status'] = false;
                        $response_array['message'] = "Table not found";
                    }
                } else {
                    $response_array['status'] = false;
                    $response_array['message'] = "Invalid request";
                }
            } else {
                $response_array['status'] = false;
                $response_array['message'] = "Please select item";
            }
            return response()->json($response_array);
        }
    }

    public function manageFromBill($bill_id)
    {
        $toBill = Bill::where('id', $bill_id)->first();
        if (isset($toBill->getAssociateOrdersWithBill) && count($toBill->getAssociateOrdersWithBill) > 0) {
            $related_orders = $toBill->getAssociateOrdersWithBill;

            $can_delete_bill = 'yes';
            foreach ($related_orders as $orderRelation) {
                $order = $orderRelation->getAssociateOrderForBill;
                $orderedItems = OrderedItem::where('order_id', $order->id)->get();
                // dd($orderedItems);
                if (count($orderedItems)) {
                    $can_delete_bill = 'no';
                } else {
                    $update_order = Order::where('id', $order->id)->first();
                    $update_order->order_charges = null;
                    $update_order->order_final_price = 0;
                    $update_order->status = 'CANCLED';
                    BillOrderRelation::where('order_id', $order->id)->delete();
                }
            }
            if ($can_delete_bill == 'yes') {
                Bill::where('id', $toBill->id)->delete();
            }
        }
    }


    public function getTransferBillToOrderRequest(Request $request)
    {
        $from_slug = $request->from_slug;
        $to_bill_id = $request->to_bill_id;

        $fromBill = Bill::where('slug', $from_slug)->where('status', 'PENDING')->first();
        $toBill = Bill::where('id', $to_bill_id)->where('status', 'PENDING')->first();

        if ($fromBill && $toBill) {
            $data = [];
            $data['from_bill_id'] = $fromBill->id;
            $data['from_bill_slug'] = $fromBill->slug;
            foreach ($fromBill->getAssociateOrdersWithBill as $key => $fromOrders) {
                $data['from_orders'][$key]['from_order_id'] = manageOrderidWithPad($fromOrders->order_id);
                $data['from_orders'][$key]['order_items'] = $fromOrders->getAssociateOrderForBill->getAssociateItemWithOrder;
            }
            $data['to_bill_id'] = $toBill->id;
            $data['to_bill_slug'] = $toBill->slug;
            foreach ($fromBill->getAssociateOrdersWithBill as $key => $fromOrders) {
                $data['to_orders'][$key]['to_order_id'] = manageOrderidWithPad($fromOrders->order_id);
                $data['to_orders'][$key]['order_items'] = $fromOrders->getAssociateOrderForBill->getAssociateItemWithOrder;
            }

            $response_array['data'] = $data;
            $response_array['status'] = true;
            $response_array['message'] = "Trasfer Bills List";
        } else {
            $response_array['data'] = $data;
            $response_array['status'] = false;
            $response_array['message'] = "Invalid Request";
        }
        return response()->json($response_array);
    }

    public function postTransferBillToOrderRequest(Request $request)
    {
        // echo "<pre>"; print_r($request->all()); die;
        if ((isset($request->ordered_item_id) && count($request->ordered_item_id) > 0) || (isset($request->ordered_offer_id) && count($request->ordered_offer_id) > 0)) {
            $fromBill = Bill::where('slug', $request->from_bill_slug)->where('status', 'PENDING')->first();
            $toBill = Bill::where('slug', $request->to_bill_slug)->where('status', 'PENDING')->first();
            if ($fromBill && $toBill) {

                if (count($toBill->getAssociateOrdersWithBill) > 0) {
                    $firstOrderForToBill = $toBill->getAssociateOrdersWithBill->first();
                    $firstOrderDetail = $firstOrderForToBill->getAssociateOrderForBill;
                    $table_id = $firstOrderDetail->getAssociateTableWithOrder->first()->table_id;
                    $table_assignment = EmployeeTableAssignment::where('table_manager_id', $table_id)->first();
                    if ($table_assignment) {
                        $user_id = $table_assignment->user_id;
                        $new_order = new Order();
                        $new_order->user_id = $user_id;
                        $new_order->restaurant_id = $firstOrderDetail->restaurant_id;
                        $new_order->final_comment = '';
                        $new_order->order_final_price = '0';
                        $new_order->slug = rand(99, 999) . strtotime(date('Y-m-d h:i:s'));
                        $new_order->order_type = 'POSTPAID';
                        $new_order->status = 'COMPLETED';
                        $new_order->total_guests = 1;
                        $new_order->order_charges = null;
                        $new_order->payment_mode = 'NA';
                        $new_order->save();
                        $new_order_id = $new_order->id;
                        $inserting_array = [];
                        $inner_array = [
                            'order_id' => $new_order_id,
                            'table_id' => $table_id
                        ];
                        $inserting_array[] = $inner_array;
                        OrderBookedTable::insert($inserting_array);

                        $bill_relation = new BillOrderRelation();
                        $bill_relation->bill_id = $toBill->id;
                        $bill_relation->order_id = $new_order_id;
                        $bill_relation->save();


                        if (isset($request->ordered_item_id) && count($request->ordered_item_id) > 0) {
                            //transfer orders item
                            $all_item_ids = array_keys($request->ordered_item_id);

                            $allOrdersForUpdate = [$new_order_id];
                            foreach ($all_item_ids as $ordered_item_id) {
                                $original = 'original_qty_' . $ordered_item_id;
                                $selected = 'selected_qty_' . $ordered_item_id;
                                $relatedOrderItem = OrderedItem::where('id', $ordered_item_id)->first();
                                $relatedOrderId = $relatedOrderItem->order_id;
                                $allOrdersForUpdate[] = $relatedOrderId;
                                if ($request->$original == $request->$selected) {
                                    OrderedItem::where('id', $ordered_item_id)->update(['order_id' => $new_order_id]);
                                } else {
                                    $oldOrderedItem = OrderedItem::where('id', $ordered_item_id)->first();
                                    //create new ordereditem
                                    $leftQuantity = $request->$original - $request->$selected;
                                    $newOrderItem = new OrderedItem();
                                    $newOrderItem->order_id = $new_order_id;
                                    $newOrderItem->food_item_id = $oldOrderedItem->food_item_id;
                                    $newOrderItem->order_offer_id = $oldOrderedItem->order_offer_id;
                                    $newOrderItem->restaurant_id = $oldOrderedItem->restaurant_id;
                                    $newOrderItem->price = $oldOrderedItem->price;
                                    $newOrderItem->item_title = $oldOrderedItem->item_title;
                                    $newOrderItem->item_comment = $oldOrderedItem->item_comment;
                                    $newOrderItem->item_quantity = $request->$selected;
                                    $newOrderItem->condiments_json = $oldOrderedItem->condiments_json;
                                    $newOrderItem->print_class_id = $oldOrderedItem->print_class_id;
                                    $newOrderItem->item_delivery_status = $oldOrderedItem->item_delivery_status;
                                    $newOrderItem->created_at = $oldOrderedItem->created_at;
                                    $newOrderItem->updated_at = $oldOrderedItem->updated_at;
                                    $newOrderItem->billing_time = $oldOrderedItem->billing_time;
                                    $oldOrderedItem_item_charges = json_decode($oldOrderedItem->item_charges);
                                    if (is_array($oldOrderedItem_item_charges) && count($oldOrderedItem_item_charges) > 0) {
                                        foreach ($oldOrderedItem_item_charges as $charges) {
                                            $charges_arr[strtoupper($charges->charges_name)]['charges_name'] = $charges->charges_name;
                                            $charges_arr[strtoupper($charges->charges_name)]['charges_value'] = $charges->charges_value;
                                            $charges_arr[strtoupper($charges->charges_name)]['charges_format'] = $charges->charges_format;
                                            $new_charges_arr[strtoupper($charges->charges_name)]['charges_name'] = $charges->charges_name;
                                            $new_charges_arr[strtoupper($charges->charges_name)]['charges_value'] = $charges->charges_value;
                                            $new_charges_arr[strtoupper($charges->charges_name)]['charges_format'] = $charges->charges_format;
                                            if (isset($charges_arr[strtoupper($charges->charges_name)]['charged_amount'])) {
                                                $spillted_chared_amount = $charges->charged_amount / $request->$original;
                                                $new_amount = $spillted_chared_amount * $request->$selected;
                                                $charges_arr[strtoupper($charges->charges_name)]['charged_amount'] = $charges_arr[strtoupper($charges->charges_name)]['charged_amount'] + $new_amount;

                                                $newCgareAmount = $spillted_chared_amount * $leftQuantity;
                                                $new_charges_arr[strtoupper($charges->charges_name)]['charged_amount'] = $new_charges_arr[strtoupper($charges->charges_name)]['charged_amount'] + $newCgareAmount;
                                            } else {
                                                $spillted_chared_amount = $charges->charged_amount / $request->$original;
                                                $new_amount = $spillted_chared_amount * $request->$selected;
                                                $charges_arr[strtoupper($charges->charges_name)]['charged_amount'] = $new_amount;

                                                $newCgareAmount = $spillted_chared_amount * $leftQuantity;

                                                $new_charges_arr[strtoupper($charges->charges_name)]['charged_amount'] = $newCgareAmount;
                                            }
                                        }
                                        $newOrderItem->item_charges = json_encode(array_values($charges_arr));
                                        $oldOrderedItem->item_charges = json_encode(array_values($new_charges_arr));
                                    }
                                    $oldOrderedItem->item_quantity = $leftQuantity;
                                    $oldOrderedItem->save();
                                    $newOrderItem->save();
                                }
                            }
                            $this->updateOrderStatsAfterTransfer($allOrdersForUpdate);
                            $this->manageFromBill($fromBill->id);

                            $response_array['status'] = true;
                            $response_array['message'] = "Bill transferred successfully";
                        }
                    } else {
                        $response_array['status'] = false;
                        $response_array['message'] = "Table not found";
                    }
                } else {
                    $response_array['status'] = false;
                    $response_array['message'] = "Do not have any order";
                }
            } else {
                $response_array['status'] = false;
                $response_array['message'] = "Invalid request";
            }
        } else {
            $response_array['status'] = false;
            $response_array['message'] = "Please select item";
        }

        return response()->json($response_array);
    }


    public function updateOrderStatsAfterTransfer($order_ids_arr)
    {
        // $order_ids_arr= [1255];
        foreach ($order_ids_arr as $order_id) {
            $order = Order::whereId($order_id)->first();
            $ordered_item = $order->getAssociateItemWithOrder;
            $ordered_offer = $order->getAssociateOffersWithOrder;
            $total_amount_arr = [];
            $charges_arr = [];

            if (count($ordered_item) > 0 || count($ordered_offer) > 0) {
                foreach ($ordered_item as $item) {
                    if ($item->item_delivery_status != 'CANCLED' && !$item->order_offer_id) {
                        $total_amount_arr[] = $item->item_quantity * $item->price;
                        //manage charges start
                        $item_charges = json_decode($item->item_charges);
                        if (is_array($item_charges) && count($item_charges) > 0) {
                            foreach ($item_charges as $charges) {
                                $charges_arr[strtoupper($charges->charges_name)]['charges_name'] = $charges->charges_name;
                                $charges_arr[strtoupper($charges->charges_name)]['charges_value'] = $charges->charges_value;
                                $charges_arr[strtoupper($charges->charges_name)]['charges_format'] = $charges->charges_format;

                                if (isset($charges_arr[strtoupper($charges->charges_name)]['charged_amount'])) {
                                    $charges_arr[strtoupper($charges->charges_name)]['charged_amount'] = $charges_arr[strtoupper($charges->charges_name)]['charged_amount'] + $charges->charged_amount;
                                } else {
                                    $charges_arr[strtoupper($charges->charges_name)]['charged_amount'] = $charges->charged_amount;
                                }
                            }
                        }
                    }
                    //manage charges end
                }

                foreach ($ordered_offer as $offer) {
                    $total_amount_arr[] = $offer->quantity * $offer->price;


                    //manage charges start
                    $offer_charges = json_decode($offer->offer_charges);
                    if (is_array($offer_charges) && count($offer_charges) > 0) {
                        foreach ($offer_charges as $charges) {
                            $charges_arr[strtoupper($charges->charges_name)]['charges_name'] = $charges->charges_name;
                            $charges_arr[strtoupper($charges->charges_name)]['charges_value'] = $charges->charges_value;
                            $charges_arr[strtoupper($charges->charges_name)]['charges_format'] = $charges->charges_format;

                            if (isset($charges_arr[strtoupper($charges->charges_name)]['charged_amount'])) {
                                $charges_arr[strtoupper($charges->charges_name)]['charged_amount'] = $charges_arr[strtoupper($charges->charges_name)]['charged_amount'] + $charges->charged_amount;
                            } else {
                                $charges_arr[strtoupper($charges->charges_name)]['charged_amount'] = $charges->charged_amount;
                            }
                        }
                    }
                    //manage charges end
                }
                $order->order_charges = json_encode(array_values($charges_arr));
                $sum_of_total_price = array_sum($total_amount_arr);
                if ($order->admin_discount_in_percent > 0) {
                    if ($sum_of_total_price > 0) {
                        $percent = ($order->admin_discount_in_percent * $sum_of_total_price) / 100;
                        $discount_percent = [
                            [
                                'discount_title' => 'Promotion Discount',
                                'discount_value' => $order->admin_discount_in_percent,
                                'discount_format' => 'PERCENTAGE',
                                'discount_amount' => round($percent, 2)
                            ]
                        ];
                        $order->order_discounts = json_encode($discount_percent);
                        $order->order_final_price = round($sum_of_total_price - $percent, 2);
                    }
                } else {
                    $order->order_final_price = $sum_of_total_price;
                }
            } else {
                $order->order_charges = null;
                $order->order_final_price = 0;
                $order->status = 'CANCLED';
            }
            $order->save();
        }
    }


    public function getTotalEarningStats()
    {
        //current week date range
        $monday = strtotime("last monday");
        $monday = date('w', $monday) == date('w') ? $monday + 7 * 86400 : $monday;
        $sunday = strtotime(date("Y-m-d", $monday) . " +6 days");
        //previous week date range
        $previous_week = strtotime("-1 week");
        $start_week = strtotime("last monday", $previous_week);
        $end_week = strtotime("next sunday", $start_week);

        $borrwed_amountbyDateArray = [
            'this_week' => manageAmountFormat($this->getTotalEarning(date("Y-m-d", $monday), date("Y-m-d", $sunday))),
            'last_week' => manageAmountFormat($this->getTotalEarning(date("Y-m-d", $start_week), date("Y-m-d", $end_week))),
            'this_month' => manageAmountFormat($this->getTotalEarning(date('Y-m-01'), date('Y-m-t'))),
            'last_month' => manageAmountFormat($this->getTotalEarning(date('Y-m-01', strtotime('last month')), date('Y-m-t', strtotime('last month')))),
            'till_date' => manageAmountFormat($this->getTotalEarning(null, date('Y-m-d')))
        ];
        return $borrwed_amountbyDateArray;
    }

    public function getTotalEarning($start_date = null, $end_date = null)
    {
        if (!$start_date) {
            $total_amount = Order::where('order_type', 'PREPAID')
                ->whereDate('created_at', '<=', $end_date)
                ->sum('order_final_price');
        } else {
            $start_date = $start_date . ' 00:00:00';
            $end_date = $end_date . ' 23:59:59';
            $total_amount = Order::where('order_type', 'PREPAID')
                ->whereBetween('created_at', [$start_date, $end_date])
                ->sum('order_final_price');
        }
        return $total_amount;
    }

    public function getunpaidbill(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $lists = Bill::with(['getAssociateOrdersWithBill.getAssociateOrderForBill'])->where('status', 'PENDING');
            $lists = $lists->orderBy('id', 'desc')->get();
            $data = [];
            foreach ($lists as $list) {
                $data[$list->user_id]['waiter_name'] = $list->getAssociateUserForBill->name;
                $totalorderamnt = 0;
                foreach ($list->getAssociateOrdersWithBill as $single_order) {
                    $totalorderamnt += $single_order->getAssociateOrderForBill->order_final_price;
                }

                $data[$list->user_id]['total_bills'][] = 1;
                $data[$list->user_id]['total_amount'][] = $totalorderamnt;
            }
            $finaldata = [];
            $indx = 0;
            $grandtotal = 0;
            foreach ($data as $list) {
                $finaldata[$indx]['waiter_name'] = $list['waiter_name'];
                $finaldata[$indx]['total_bills'] = array_sum($list['total_bills']);
                $finaldata[$indx]['total_amount'] = array_sum($list['total_amount']);
                $grandtotal += array_sum($list['total_amount']);
                $indx++;
            }
            $datas = array_values($finaldata);
            //   $datas['grand_total'] = $grandtotal;
            //            echo "<pre>"; print_r($finaldata); die;
            return response()->json(['status' => true, 'message' => 'Bill listing', 'data' => $datas]);
        }
    }

    public function getallunpaidbill(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $lists = Bill::with(['getAssociateOrdersWithBill.getAssociateOrderForBill'])->where('status', 'PENDING');
            $lists = $lists->orderBy('id', 'desc')->get();
            $data = [];
            foreach ($lists as $key => $list) {
                $data[$key]['bill_id'] = $list->id;
                $data[$key]['bill_slug'] = $list->slug;
                $data[$key]['bill_date'] = date('d M,Y h:i A', strtotime($list->created_at));
                $data[$key]['waiter_name'] = $list->getAssociateUserForBill->name;
                $data[$key]['total_orders'] = count($list->getAssociateOrdersWithBill);
                $totalorderamnt = 0;
                foreach ($list->getAssociateOrdersWithBill as $single_order) {
                    $totalorderamnt += $single_order->getAssociateOrderForBill->order_final_price;
                }

                $data[$key]['total_bills'][] = 1;
                $data[$key]['total_amount'][] = $totalorderamnt;
            }
            $finaldata = [];
            $indx = 0;
            $grandtotal = 0;
            //echo "<pre>"; print_r($data); die;
            foreach ($data as $list) {
                $finaldata[$indx]['bill_id'] = $list['bill_id'];
                $finaldata[$indx]['bill_slug'] = $list['bill_slug'];
                $finaldata[$indx]['bill_date'] = $list['bill_date'];
                $finaldata[$indx]['waiter_name'] = $list['waiter_name'];
                $finaldata[$indx]['total_orders'] = $list['total_orders'];
                $finaldata[$indx]['total_amount'] = array_sum($list['total_amount']);
                $grandtotal += array_sum($list['total_amount']);
                $indx++;
            }
            $datas = array_values($finaldata);
            //   $datas['grand_total'] = $grandtotal;
            //            echo "<pre>"; print_r($finaldata); die;
            return response()->json(['status' => true, 'message' => 'Bill listing', 'data' => $datas]);
        }
    }

    public function getPaymentMethod(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'type' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            if ($request->type == '1') {
                //   $lists = PaymentMethod::select('id','title','gl_account_id')->whereIn('gl_account_id',['38','41','152','153'])->orderBy('id', 'DESC')->get();
                $lists = PaymentMethod::whereIn('gl_account_id', ['41', '152', '153', '40', '163'])->orderBy('id', 'DESC')
                    ->get()->map(function ($list) {
                        $list->show_balance = ($list->gl_account_id == 163 ? 1 : 0);
                        return $list;
                    });
            } else {
                $lists = PaymentMethod::where('gl_account_id', '2')->orderBy('id', 'DESC')
                    ->get()->map(function ($list) {
                        $list->show_balance = ($list->gl_account_id == 163 ? 1 : 0);
                        return $list;
                    });
            }
            return response()->json(['status' => true, 'message' => 'Payment listing', 'data' => $lists]);
        }
    }

    public function getCheckOut(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            //	 'customer' => 'required',      
            //	 'cart' => 'required'  
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            //   $check = DB::transaction(function () use ($request) {
            // \DB::connection()->enableQueryLog();
            $cartlist = json_decode(json_encode($request->cart));
            $getUserData = User::where('id', $request->user_id)->first();

            $grn_number = getCodeWithNumberSeriesPOS('POS');
            $salesno = getCodeWithNumberSeriesPOS('SE');
            $rows = (object)[];
            if ($getUserData->route) {
            }
            $rows = WaCustomer::where('route_id', $getUserData->route)->first();
            // $salescustomer = \App\Model\WaSalesmanCustomer::where('telephone')                 
            // if(!$salescustomer){
            // }
            $salescustomer = new \App\Model\WaSalesmanCustomer();
            $salescustomer->telephone = $request->phone;
            $salescustomer->salesman_id = $getUserData->wa_location_and_store_id;
            $salescustomer->salesman_user_id = $getUserData->id;
            $salescustomer->document_no = $grn_number;
            $salescustomer->sales_no = $salesno;
            $salescustomer->customer_name = $request->customerName;
            $salescustomer->address = $request->postofficeaddress;
            $salescustomer->country = $request->country;
            $salescustomer->contact_person = $request->contactperson;
            $salescustomer->street = $request->street;
            $salescustomer->town = $request->town;
            $salescustomer->customer_id = @$rows->id;
            $salescustomer->save();


            $accountuingPeriod = WaAccountingPeriod::where('is_current_period', '1')->first();
            $series_module = WaNumerSeriesCode::where('module', 'POS')->first();
            $dateTime = date('Y-m-d H:i:s');

            if (isset($request->cart) && count($request->cart) > 0) {

                $totalPriceExcVAT = 0;
                $totalVatAmount = 0;
                $totalAmount = 0;
                $dateTime = date('Y-m-d H:i:s');

                $shiftdata = WaShift::where('status', 'open')->where('id', $request->shift_id)->first();

                $rowcashsales = new WaCashSales();
                $rowcashsales->cash_sales_number = $salesno;
                $rowcashsales->shift_id = $request->shift_id;
                $rowcashsales->route = $shiftdata->route ?? NULL;
                $rowcashsales->vehicle_reg_no = $shiftdata->vehicle_register_no ?? NULL;
                $rowcashsales->wa_customer_id = @$rows->id;
                $rowcashsales->creater_id = $request->user_id;
                $rowcashsales->order_date = date('Y-m-d');
                $rowcashsales->accounting_month = @$accountuingPeriod->period_month;
                $rowcashsales->document_no = $grn_number;

                $rowcashsales->save();

                $cashsalesid = $rowcashsales->id;

                updateUniqueNumberSeries('SE', $rowcashsales->cash_sales_number);
                updateUniqueNumberSeries('POS', $grn_number);
                $taxVat = TaxManager::with(['getOutputGlAccount'])->where('slug', 'vat')->first();
                $methodAccId = WaChartsOfAccount::where('id', $request->gl_account_id)->first();
                $WaGlTran = [];
                $WaStockMove = [];
                $WaCashSalesItem = [];
                $WaDebtorTran = [];
                if ($request->gl_account_id == 41) {
                    $file_data = $request->input('chequepic');
                    $file_name = 'cheque__' . $dateTime . '.png'; //generating unique file name;

                    if ($file_data != "") { // storing image in storage/app/public Folder
                        Storage::disk('uploads')->put($file_name, base64_decode($file_data));
                    }
                } else {
                    $file_name = "";
                }
                $inventory = \App\Model\WaInventoryItem::with([
                    'getInventoryCategoryDetail',
                    'getInventoryCategoryDetail.getStockGlDetail',
                    'getInventoryCategoryDetail.getIssueGlDetail',
                    'getInventoryCategoryDetail.getWIPGlDetail',
                    'getAllFromStockMoves'
                ])->get();
                foreach ($cartlist as $val) {
                    $WaInventoryItem = $inventory->find($val->id);
                    $stock_qoh = $WaInventoryItem->getAllFromStockMoves->where('wa_location_and_store_id', $getUserData->wa_location_and_store_id)->sum('qauntity') ?? 0;
                    if ($stock_qoh < $val->quantity) {
                        continue;
                    }
                    if ($this->checkQuantity($getUserData->wa_location_and_store_id, $val->stockcode, $val->quantity) == '0') {
                        //	return response()->json(['status'=>false,'message'=>'('.$val->stockcode.') out of stock.']);	
                        $stock_qoh -= $val->quantity;

                        $WaStockMove[] = [
                            'user_id' => $request->user_id,
                            'restaurant_id' => $getUserData->restaurant_id,
                            'wa_location_and_store_id' => $getUserData->wa_location_and_store_id,
                            'wa_inventory_item_id' => $val->id,
                            'standard_cost' => $val->standard_cost,
                            'qauntity' => -($val->quantity),
                            'new_qoh' => $stock_qoh,
                            'stock_id_code' => $val->stockcode,
                            'grn_type_number' => $series_module->type_number,
                            'shift_id' => $shiftdata->id ?? NULL,
                            'grn_last_nuber_used' => $series_module->last_number_used,
                            'price' => $val->price,
                            'refrence' => $shiftdata->id ?? NULL,
                            'document_no' => $grn_number,
                            'updated_at' => date('Y-m-d H:i:s'),
                            'created_at' => date('Y-m-d H:i:s'),
                        ];
                        $vatrate = $taxVat->tax_value;

                        $totalPrice = $val->price * $val->quantity;

                        $PriceExcVAT = ($totalPrice * 100) / (100 + $vatrate);


                        $craccountno = @$WaInventoryItem->getInventoryCategoryDetail->getStockGlDetail->account_code; //Inventory Account

                        $draccountno = @$WaInventoryItem->getInventoryCategoryDetail->getIssueGlDetail->account_code; //COS GL

                        $WaCashSalesItem[] = [
                            'wa_cash_sales_id' => $cashsalesid,
                            'quantity' => $val->quantity,
                            'item_no' => $val->id,
                            'item_name' => @$WaInventoryItem->title,
                            'standard_cost' => $val->standard_cost,
                            'unit_price' => $val->price,
                            'actual_unit_price' => $val->price,
                            'total_cost' => ($val->quantity * $val->standard_cost),
                            'document_no' => $grn_number,
                            'updated_at' => date('Y-m-d H:i:s'),
                            'created_at' => date('Y-m-d H:i:s'),
                        ];

                        if ($request->gl_account_id == 2) {
                            $WaDebtorTran[] = [
                                'salesman_user_id' => $request->user_id,
                                'salesman_id' => $getUserData->wa_location_and_store_id,
                                'type_number' => $series_module->type_number,
                                'wa_customer_id' => @$rows->id,
                                'customer_number' => @$rows->customer_code,
                                'trans_date' => $dateTime,
                                'input_date' => $dateTime,
                                'invoice_customer_name' => $salescustomer->customer_name,
                                'wa_accounting_period_id' => $accountuingPeriod ? $accountuingPeriod->id : null,
                                'shift_id' => $shiftdata->id ?? NULL,
                                'reference' => $shiftdata->shift_id ?? NULL,
                                'amount' => $totalPrice,
                                'document_no' => $grn_number,
                                'updated_at' => date('Y-m-d H:i:s'),
                                'created_at' => date('Y-m-d H:i:s'),
                            ];
                        }

                        $WaGlTran[] = [
                            'period_number' => $accountuingPeriod ? $accountuingPeriod->period_no : null,
                            'grn_type_number' => $series_module->type_number,
                            'grn_last_used_number' => $series_module->last_number_used,
                            'transaction_type' => $series_module->description,
                            'transaction_no' => $grn_number,
                            'trans_date' => $dateTime,
                            'restaurant_id' => $getUserData->restaurant_id,
                            'shift_id' => $request->shift_id,
                            'account' => $craccountno,
                            'amount' => '-' . $val->standard_cost * $val->quantity,
                            'narrative' => $val->stockcode . '/' . @$WaInventoryItem->title . '/' . $val->standard_cost . '@' . $val->quantity,
                            'reference' => NULL,
                            'supplier_account_number' => NULL,
                            'updated_at' => date('Y-m-d H:i:s'),
                            'created_at' => date('Y-m-d H:i:s'),
                            'cheque_image' => NULL
                        ];

                        $WaGlTran[] = [
                            'period_number' => $accountuingPeriod ? $accountuingPeriod->period_no : null,
                            'grn_type_number' => $series_module->type_number,
                            'grn_last_used_number' => $series_module->last_number_used,
                            'transaction_type' => $series_module->description,
                            'transaction_no' => $grn_number,
                            'trans_date' => $dateTime,
                            'restaurant_id' => $getUserData->restaurant_id,
                            'shift_id' => $request->shift_id,
                            'account' => $draccountno,
                            'amount' => $val->standard_cost * $val->quantity,
                            'narrative' => $val->stockcode . '/' . @$WaInventoryItem->title . '/' . $val->standard_cost . '@' . $val->quantity,
                            'reference' => NULL,
                            'supplier_account_number' => NULL,
                            'updated_at' => date('Y-m-d H:i:s'),
                            'created_at' => date('Y-m-d H:i:s'),
                            'cheque_image' => NULL
                        ];


                        $totalPriceExcVAT = $PriceExcVAT;
                        $totalVatAmount = ($totalPrice - $PriceExcVAT); //($taxVat->tax_value * $totalPrice) / 100; //($PriceExcVAT - $totalPrice);
                        $totalAmount = $totalPrice;
                    }


                    $salesaccountno = @$WaInventoryItem->getInventoryCategoryDetail->getWIPGlDetail->account_code; //Sales GL

                    $WaGlTran[] = [
                        'period_number' => $accountuingPeriod ? $accountuingPeriod->period_no : null,
                        'grn_type_number' => $series_module->type_number,
                        'grn_last_used_number' => $series_module->last_number_used,
                        'transaction_type' => $series_module->description,
                        'transaction_no' => $grn_number,
                        'trans_date' => $dateTime,
                        'restaurant_id' => $getUserData->restaurant_id,
                        'shift_id' => $request->shift_id,
                        'account' => $salesaccountno,
                        'amount' => '-' . $totalPriceExcVAT,
                        'narrative' => $request->referencecode,
                        'reference' => $request->comment,
                        'supplier_account_number' => NULL,
                        'updated_at' => date('Y-m-d H:i:s'),
                        'created_at' => date('Y-m-d H:i:s'),
                        'cheque_image' => NULL
                    ];


                    if ($taxVat && $totalVatAmount > 0) {
                        $WaGlTran[] = [
                            'period_number' => $accountuingPeriod ? $accountuingPeriod->period_no : null,
                            'grn_type_number' => $series_module->type_number,
                            'grn_last_used_number' => $series_module->last_number_used,
                            'transaction_type' => $series_module->description,
                            'transaction_no' => $grn_number,
                            'trans_date' => $dateTime,
                            'restaurant_id' => $getUserData->restaurant_id,
                            'shift_id' => $request->shift_id,
                            'account' => $taxVat->getOutputGlAccount->account_code,
                            'amount' => '-' . $totalVatAmount,
                            'narrative' => $request->referencecode,
                            'reference' => $request->comment,
                            'supplier_account_number' => NULL,
                            'updated_at' => date('Y-m-d H:i:s'),
                            'created_at' => date('Y-m-d H:i:s'),
                            'cheque_image' => NULL
                        ];
                    }

                    if ($request->gl_account_id == 2) {
                        $accountNo = '13004';
                    } else {
                        $accountNo = @$methodAccId->account_code;
                    }


                    $WaGlTran[] = [
                        'period_number' => $accountuingPeriod ? $accountuingPeriod->period_no : null,
                        'grn_type_number' => $series_module->type_number,
                        'grn_last_used_number' => $series_module->last_number_used,
                        'transaction_type' => $series_module->description,
                        'transaction_no' => $grn_number,
                        'trans_date' => $dateTime,
                        'restaurant_id' => $getUserData->restaurant_id,
                        'shift_id' => $request->shift_id,
                        'account' => $accountNo,
                        'amount' => $totalAmount,
                        'narrative' => $request->referencecode,
                        'reference' => $request->comment,
                        'supplier_account_number' => NULL,
                        'updated_at' => date('Y-m-d H:i:s'),
                        'created_at' => date('Y-m-d H:i:s'),
                        'cheque_image' => 'public/uploads/cheque_images/' . $file_name,
                    ];
                }
                if (count($WaDebtorTran) > 0) {
                    WaDebtorTran::insert($WaDebtorTran);
                }
                if (count($WaDebtorTran) > 0) {
                    \App\Model\WaSalesmanTran::insert($WaDebtorTran);
                }
                if (count($WaCashSalesItem) > 0) {
                    WaCashSalesItem::insert($WaCashSalesItem);
                }
                if (count($WaStockMove) > 0) {
                    WaStockMove::insert($WaStockMove);
                }
                if (count($WaGlTran) > 0) {
                    WaGlTran::insert($WaGlTran);
                }

                // $queries = \DB::getQueryLog();
                // return response()->json(['status'=>false,'message'=>json_encode($queries)]);
                //	echo $totalVatAmount." - ".$totalAmount.' - '.$totalPriceExcVAT; 
            }
            //         return true;
            //   });

            return response()->json(['status' => true, 'message' => 'Order Placed Successfully.', 'transaction_no' => $grn_number]);
            //   if($check){
            //   }else{
            //     return response()->json(['status'=>false,'message'=>'Something went wrong']);
            //   }

        }
    }

    public function getCheckOut_old(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            //	 'customer' => 'required',      
            //	 'cart' => 'required'  
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $cartlist = json_decode(json_encode($request->cart));
            $getUserData = User::where('id', $request->user_id)->first();

            /*
                if(isset($request->cart) && count($request->cart) > 0){				
                   foreach($cartlist as $val){ 
                    if($this->checkQuantity($getUserData->wa_location_and_store_id,$val->stockcode,$val->quantity)=='0'){
                        return response()->json(['status'=>false,'message'=>'('.$val->stockcode.') out of stock.']);	
                    }
                   }
                }
*/

            $rows = WaCustomer::where('telephone', $request->phone)->first();

            if ($rows == "") {
                $rows = new WaCustomer();
            }
            $rows->customer_code = getCodeWithNumberSeries('CUSTOMERS');
            $rows->customer_name = $request->customerName;
            $rows->address = $request->postofficeaddress;
            $rows->country = $request->country;
            $rows->telephone = $request->phone;
            $rows->contact_person = $request->contactperson;
            $rows->street = $request->street;
            $rows->town = $request->town;
            $rows->save();

            updateUniqueNumberSeries('CUSTOMERS', $rows->customer_code);

            $accountuingPeriod = WaAccountingPeriod::where('is_current_period', '1')->first();
            $series_module = WaNumerSeriesCode::where('module', 'POS')->first();
            $dateTime = date('Y-m-d H:i:s');
            $grn_number = getCodeWithNumberSeriesPOS('POS');

            if (isset($request->cart) && count($request->cart) > 0) {

                $totalPriceExcVAT = 0;
                $totalVatAmount = 0;
                $totalAmount = 0;
                $dateTime = date('Y-m-d H:i:s');

                $shiftdata = WaShift::where('status', 'open')->where('id', $request->shift_id)->first();

                $rowcashsales = new WaCashSales();
                $rowcashsales->cash_sales_number = getCodeWithNumberSeries('SE');
                $rowcashsales->shift_id = $request->shift_id;
                $rowcashsales->route = $shiftdata->route;
                $rowcashsales->vehicle_reg_no = $shiftdata->vehicle_register_no;
                $rowcashsales->wa_customer_id = $rows->id;
                $rowcashsales->creater_id = $request->user_id;
                $rowcashsales->order_date = date('Y-m-d');
                $rowcashsales->document_no = $grn_number;

                $rowcashsales->save();

                $cashsalesid = $rowcashsales->id;

                updateUniqueNumberSeries('SE', $request->cash_sales_number);
                updateUniqueNumberSeries('POS', $grn_number);


                foreach ($cartlist as $val) {

                    if ($this->checkQuantity($getUserData->wa_location_and_store_id, $val->stockcode, $val->quantity) == '0') {
                        //	return response()->json(['status'=>false,'message'=>'('.$val->stockcode.') out of stock.']);	

                        $stockMove = new WaStockMove();
                        $stockMove->user_id = $request->user_id;
                        $stockMove->restaurant_id = $getUserData->restaurant_id;
                        $stockMove->wa_location_and_store_id = $getUserData->wa_location_and_store_id;
                        $stockMove->wa_inventory_item_id = $val->id;
                        $stockMove->standard_cost = $val->standard_cost;
                        $stockMove->qauntity = -($val->quantity);
                        $stockMove->stock_id_code = $val->stockcode;
                        $stockMove->grn_type_number = $series_module->type_number;
                        $stockMove->shift_id = $shiftdata->id;
                        $stockMove->grn_last_nuber_used = $series_module->last_number_used;
                        $stockMove->price = $val->price;
                        $stockMove->refrence = $shiftdata->id;
                        $stockMove->document_no = $grn_number;
                        $stockMove->save();


                        $taxVat = TaxManager::where('slug', 'vat')->first();
                        $vatrate = $taxVat->tax_value;

                        $totalPrice = $val->price * $val->quantity;

                        $PriceExcVAT = ($totalPrice * 100) / (100 + $vatrate);

                        $WaInventoryItem = WaInventoryItem::where('id', $val->id)->first();

                        $craccountno = @$WaInventoryItem->getInventoryCategoryDetail->getStockGlDetail->account_code; //Inventory Account

                        $draccountno = @$WaInventoryItem->getInventoryCategoryDetail->getIssueGlDetail->account_code; //COS GL

                        $item = new WaCashSalesItem();
                        $item->wa_cash_sales_id = $cashsalesid;
                        $item->quantity = $val->quantity;
                        $item->item_no = $val->id;
                        $item->item_name = $WaInventoryItem->title;
                        $item->standard_cost = $val->standard_cost;
                        $item->unit_price = $val->price;
                        $item->actual_unit_price = $val->price;
                        $item->total_cost = ($val->quantity * $val->standard_cost);
                        $item->document_no = $grn_number;

                        $item->save();

                        if ($request->gl_account_id == 2) {
                            $saveDebtor = new WaDebtorTran();
                            $saveDebtor->salesman_id = $request->user_id;
                            $saveDebtor->type_number = $series_module->type_number;
                            $saveDebtor->wa_customer_id = $rows->id;
                            $saveDebtor->customer_number = $rows->customer_code;
                            $saveDebtor->trans_date = $dateTime;
                            $saveDebtor->input_date = $dateTime;
                            $saveDebtor->wa_accounting_period_id = $accountuingPeriod ? $accountuingPeriod->id : null;;
                            $saveDebtor->shift_id = $shiftdata->id;
                            $saveDebtor->reference = $shiftdata->shift_id;
                            $saveDebtor->amount = $totalPrice;
                            $saveDebtor->document_no = $grn_number;
                            $saveDebtor->save();
                        }


                        $dr = new WaGlTran();
                        $dr->period_number = $accountuingPeriod ? $accountuingPeriod->period_no : null;
                        $dr->grn_type_number = $series_module->type_number;
                        $dr->grn_last_used_number = $series_module->last_number_used;
                        $dr->transaction_type = $series_module->description;
                        $dr->transaction_no = $grn_number;
                        $dr->trans_date = $dateTime;
                        $dr->restaurant_id = $getUserData->restaurant_id;
                        $dr->period_number = null;
                        $dr->shift_id = $request->shift_id;
                        $dr->account = $craccountno;
                        $dr->amount = '-' . $val->standard_cost * $val->quantity;
                        $dr->narrative = $val->stockcode . '/' . $WaInventoryItem->title . '/' . $val->standard_cost . '@' . $val->quantity;
                        $dr->save();

                        $dr = new WaGlTran();
                        $dr->period_number = $accountuingPeriod ? $accountuingPeriod->period_no : null;
                        $dr->grn_type_number = $series_module->type_number;
                        $dr->grn_last_used_number = $series_module->last_number_used;
                        $dr->transaction_type = $series_module->description;
                        $dr->transaction_no = $grn_number;
                        $dr->trans_date = $dateTime;
                        $dr->shift_id = $request->shift_id;
                        $dr->shift_id = $getUserData->restaurant_id;
                        $dr->period_number = null;
                        $dr->account = $draccountno;
                        $dr->amount = $val->standard_cost * $val->quantity;
                        $dr->narrative = $val->stockcode . '/' . $WaInventoryItem->title . '/' . $val->standard_cost . '@' . $val->quantity;
                        $dr->save();

                        $totalPriceExcVAT += $PriceExcVAT;
                        $totalVatAmount += ($totalPrice - $PriceExcVAT); //($taxVat->tax_value * $totalPrice) / 100; //($PriceExcVAT - $totalPrice);
                        $totalAmount += $totalPrice;
                    }

                    $methodAccId = WaChartsOfAccount::where('id', $request->gl_account_id)->first();

                    $salesaccountno = $WaInventoryItem->getInventoryCategoryDetail->getWIPGlDetail->account_code; //Sales GL

                    $cr = new WaGlTran();
                    $cr->period_number = $accountuingPeriod ? $accountuingPeriod->period_no : null;
                    $cr->grn_type_number = $series_module->type_number;
                    $cr->transaction_type = $series_module->description;
                    $cr->transaction_no = $grn_number;
                    $cr->grn_last_used_number = $series_module->last_number_used;
                    $cr->trans_date = $dateTime;
                    $cr->restaurant_id = $getUserData->restaurant_id;
                    $cr->period_number = null;
                    $cr->shift_id = $request->shift_id;
                    $cr->supplier_account_number = null;
                    $cr->account = $salesaccountno;
                    $cr->amount = '-' . $totalPriceExcVAT;
                    $cr->narrative = $request->referencecode;
                    $cr->reference = $request->comment;
                    $cr->save();

                    $taxVat = TaxManager::where('slug', 'vat')->first();

                    if ($taxVat && $totalVatAmount > 0) {
                        $vat = new WaGlTran();
                        $vat->period_number = $accountuingPeriod ? $accountuingPeriod->period_no : null;
                        $vat->grn_type_number = $series_module->type_number;
                        $vat->transaction_type = $series_module->description;
                        $vat->transaction_no = $grn_number;
                        $vat->grn_last_used_number = $series_module->last_number_used;
                        $vat->trans_date = $dateTime;
                        $vat->restaurant_id = $getUserData->restaurant_id;
                        $vat->period_number = null;
                        $vat->shift_id = $request->shift_id;
                        $vat->supplier_account_number = null;
                        $vat->account = $taxVat->getOutputGlAccount->account_code;
                        $vat->amount = '-' . $totalVatAmount; //array_sum($vat_amount_arr);
                        $vat->narrative = $request->referencecode;
                        $vat->reference = $request->comment;
                        $vat->save();
                    }

                    if ($request->gl_account_id == 2) {
                        $accountNo = '13004';
                    } else {
                        $accountNo = $methodAccId->account_code;
                    }

                    if ($request->gl_account_id == 41) {
                        $file_data = $request->input('chequepic');
                        $file_name = 'cheque__' . $dateTime . '.png'; //generating unique file name;

                        if ($file_data != "") { // storing image in storage/app/public Folder
                            Storage::disk('uploads')->put($file_name, base64_decode($file_data));
                        }
                    } else {
                        $file_name = "";
                    }


                    $dr = new WaGlTran();
                    $dr->period_number = $accountuingPeriod ? $accountuingPeriod->period_no : null;
                    $dr->grn_type_number = $series_module->type_number;
                    $dr->grn_last_used_number = $series_module->last_number_used;
                    $dr->transaction_type = $series_module->description;
                    $dr->transaction_no = $grn_number;
                    $dr->trans_date = $dateTime;
                    $dr->shift_id = $request->shift_id;
                    $dr->restaurant_id = $getUserData->restaurant_id;
                    $dr->period_number = null;
                    $dr->account = $accountNo;
                    $dr->cheque_image = 'public/uploads/cheque_images/' . $file_name;
                    $dr->amount = $totalAmount;
                    $dr->narrative = $request->referencecode;
                    $dr->reference = $request->comment;
                    $dr->save();
                }
                //	echo $totalVatAmount." - ".$totalAmount.' - '.$totalPriceExcVAT; 
            }


            return response()->json(['status' => true, 'message' => 'Order Placed Successfully.', 'transaction_no' => $grn_number]);
        }
    }

    public function checkQuantity($locationid, $itemid, $qty)
    {
        try {
            $qtyOnHand = WaStockMove::where('wa_location_and_store_id', $locationid)->where('stock_id_code', $itemid)->sum('qauntity');
            // echo $qtyOnHand; die;
            $item = WaInventoryItem::select('stock_id_code', 'id')->where('stock_id_code', $itemid)->first();

            $item_id = $item->id;


            $myqty = $qty;
            $qtyOnHand = $qtyOnHand;
            if ($myqty <= $qtyOnHand) {
                return '0';
            } else {

                return '1';
            }
        } catch (\Exception $e) {

            return '1';
        }
    }

    public function postreturnsales(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'price' => 'required',
            'stockcode' => 'required',
            'shift_id' => 'required',
            'quantity' => 'required',
            'id' => 'required',
            'standard_cost' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $series_module = WaNumerSeriesCode::where('module', 'POS')->first();
            $dateTime = date('Y-m-d H:i:s');
            $grn_number = getCodeWithNumberSeriesPOS('POS');

            $getUserData = User::where('id', $request->user_id)->first();
            $getStoreData = DB::table('wa_location_and_stores')->where('location_code', 'MS')->first();
            $inventory = \App\Model\WaInventoryItem::find($request->id);
            // Removes stock from sales man store account (-)        		
            $stock_qoh = $inventory->getAllFromStockMoves->where('wa_location_and_store_id', $getUserData->wa_location_and_store_id)->sum('qauntity') ?? 0;

            $stock_qoh -= $request->quantity;
            $stockMove = new WaStockMove();
            $stockMove->user_id = $request->user_id;
            $stockMove->restaurant_id = $getUserData->restaurant_id;
            $stockMove->wa_location_and_store_id = $getUserData->wa_location_and_store_id;
            $stockMove->wa_inventory_item_id = $request->id;
            $stockMove->standard_cost = $request->standard_cost;
            $stockMove->qauntity = -($request->quantity);
            $stockMove->new_qoh = $stock_qoh;
            $stockMove->stock_id_code = $request->stockcode;
            $stockMove->grn_type_number = $series_module->type_number;
            $stockMove->grn_last_nuber_used = $series_module->last_number_used;
            $stockMove->price = $request->price;
            $stockMove->document_no = $grn_number;
            $stockMove->shift_id = $request->shift_id;
            $stockMove->refrence = $request->shift_id;
            $stockMove->stock_adjustment_id = $request->shift_id;
            $stockMove->save();

            $stock_qoh = $inventory->getAllFromStockMoves->where('wa_location_and_store_id', $getStoreData->id)->sum('qauntity') ?? 0;

            // Increases stock in Main Store MS (+)
            $stock_qoh += $request->quantity;
            $stockMove = new WaStockMove();
            $stockMove->user_id = $request->user_id;
            $stockMove->restaurant_id = $getUserData->restaurant_id;
            $stockMove->wa_location_and_store_id = $getStoreData->id;
            $stockMove->wa_inventory_item_id = $request->id;
            $stockMove->standard_cost = $request->standard_cost;
            $stockMove->qauntity = $request->quantity;
            $stockMove->new_qoh = $stock_qoh;

            $stockMove->stock_id_code = $request->stockcode;
            $stockMove->grn_type_number = $series_module->type_number;
            $stockMove->grn_last_nuber_used = $series_module->last_number_used;
            $stockMove->price = $request->price;
            //$stockMove->shift_id = $request->shift_id;
            $stockMove->document_no = $grn_number;
            $stockMove->save();
            updateUniqueNumberSeries('POS', $grn_number);

            return response()->json(['status' => true, 'message' => 'Item Returned Successfully.']);
        }
    }

    public function postallreturnsales(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'shift_id' => 'required',
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $series_module = WaNumerSeriesCode::where('module', 'POS')->first();
            $dateTime = date('Y-m-d H:i:s');
            $grn_number = getCodeWithNumberSeriesPOS('POS');
            $getUserData = User::where('id', $request->user_id)->first();
            $data = WaInventoryItem::select(
                'id',
                'stock_id_code',
                'description',
                'standard_cost',
                'selling_price',
                'minimum_order_quantity',
                DB::raw("(SELECT SUM(`qauntity`) from `wa_stock_moves` where `wa_stock_moves`.`stock_id_code` = `wa_inventory_items`.`stock_id_code` AND `wa_location_and_store_id`='" . $getUserData->wa_location_and_store_id . "') as totalQty")
            )
                ->having('totalQty', '>', 0)
                ->get();

            $getStoreData = DB::table('wa_location_and_stores')->where('location_code', 'MS')->first();
            foreach ($data as $key => $val) {
                // Removes stock from sales man store account (-)        
                $stockMove = new WaStockMove();
                $stockMove->user_id = $request->user_id;
                $stockMove->restaurant_id = $getUserData->restaurant_id;
                $stockMove->wa_location_and_store_id = $getUserData->wa_location_and_store_id;
                $stockMove->wa_inventory_item_id = $val->id;
                $stockMove->standard_cost = $val->standard_cost;
                $stockMove->qauntity = -($val->totalQty);
                $stockMove->new_qoh = 0;
                $stockMove->stock_id_code = $val->stock_id_code;
                $stockMove->grn_type_number = $series_module->type_number;
                $stockMove->grn_last_nuber_used = $series_module->last_number_used;
                $stockMove->price = $val->selling_price;
                $stockMove->shift_id = $request->shift_id;
                $stockMove->refrence = $request->shift_id;
                $stockMove->stock_adjustment_id = $request->shift_id;
                $stockMove->document_no = $grn_number;
                $stockMove->save();

                // Increases stock in Main Store MS (+)
                $stockMove = new WaStockMove();
                $stockMove->user_id = $request->user_id;
                $stockMove->restaurant_id = $getUserData->restaurant_id;
                $stockMove->wa_location_and_store_id = $getStoreData->id;
                $stockMove->wa_inventory_item_id = $val->id;
                $stockMove->standard_cost = $val->standard_cost;
                $stockMove->qauntity = ($val->totalQty);
                $stockMove->new_qoh = $val->getAllFromStockMoves->where('wa_location_and_store_id', @$getStoreData->id)->sum('qauntity');
                $stockMove->stock_id_code = $val->stock_id_code;
                $stockMove->grn_type_number = $series_module->type_number;
                $stockMove->grn_last_nuber_used = $series_module->last_number_used;
                $stockMove->price = $val->selling_price;
                $stockMove->document_no = $grn_number;
                $stockMove->save();
            }
            updateUniqueNumberSeries('POS', $grn_number);
            //WaShift::where('id',$request->shift_id)->update(['status'=>'close']);

            return response()->json(['status' => true, 'message' => 'All Item Returned Successfully.']);
        }
    }

    public function getexpenseslist(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $list = WaChartsOfAccount::select('wa_charts_of_accounts.id', 'wa_charts_of_accounts.account_name', 'wa_charts_of_accounts.account_code')->where('wa_account_groups.slug', 'salesman-expenses')
                ->join('wa_account_groups', 'wa_account_groups.id', '=', 'wa_charts_of_accounts.wa_account_group_id')
                ->get();
            return response()->json(['status' => true, 'message' => 'Get Expenses list.', 'data' => $list]);
        }
    }

    public function postexpensesdata(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'account_code' => 'required',
            'description' => 'required',
            'narration' => 'required',
            'amount' => 'required',
            'shift_id' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $series_module = WaNumerSeriesCode::where('module', 'SE')->first();
            $dateTime = date('Y-m-d H:i:s');
            $grn_number = getCodeWithNumberSeries('SE');
            $getUserData = User::where('id', $request->user_id)->first();

            //post expenses
            $dr = new WaGlTran();
            $dr->grn_type_number = $series_module->type_number;
            $dr->grn_last_used_number = $series_module->last_number_used;
            $dr->transaction_type = $series_module->description;
            $dr->transaction_no = $grn_number;
            $dr->trans_date = $dateTime;
            $dr->restaurant_id = $getUserData->restaurant_id;
            $dr->period_number = null;
            $dr->shift_id = $request->shift_id;
            $dr->account = $request->account_code;
            $dr->amount = $request->amount;
            $dr->narrative = $request->description;
            //$dr->reference = $request->comment;
            $dr->save();

            $cr = new WaGlTran();
            $cr->grn_type_number = $series_module->type_number;
            $cr->grn_last_used_number = $series_module->last_number_used;
            $cr->transaction_type = $series_module->description;
            $cr->transaction_no = $grn_number;
            $cr->trans_date = $dateTime;
            $cr->restaurant_id = $getUserData->restaurant_id;
            $cr->period_number = null;
            $cr->shift_id = $request->shift_id;
            $cr->account = '12003';
            $cr->amount = '-' . $request->amount;
            $cr->narrative = $request->description;
            //$cr->reference = $request->comment;
            $cr->save();

            return response()->json(['status' => true, 'message' => 'Expenses save successfully.']);
        }
    }

    public function getShiftlist(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $shiftlist = WaShift::where('status', 'open')->where('salesman_id', $request->get('user_id'))->get();
            return response()->json(['status' => true, 'message' => 'Shift List.', 'data' => $shiftlist]);
        }
    }

    public function getUserShiftlist(Request $request)
    {
        $user = JWTAuth::toUser($request->token);


        if ($user) {
            $shiftlist = WaShift::where('status', 'open')->where('salesman_id', $user->id)->get();
            return response()->json(['status' => true, 'message' => 'Shift List.', 'data' => $shiftlist]);
        } else {
            return response()->json(['status' => false, 'message' => 'User not found']);
        }
    }

    public function postOpenShift(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'route' => 'required',
            'vehicle_register_no' => 'required',
            'delivery_note' => 'required',
            'driver_name' => 'required',
            'turnmans_name' => 'required'
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $getUserData = User::where('id', $request->user_id)->first();
            $deliveryNote = \App\Model\NWaInventoryLocationTransfer::where('id', $request->delivery_note)->first();
            $checkshift = WaShift::where('delivery_note', $request->delivery_note)->count();
            if ($checkshift == 0) {
                $shift = new WaShift();
                $shift->shift_id = $deliveryNote->transfer_no;
                $shift->route = $request->route;
                $shift->salesman_id = $request->user_id;
                $shift->vehicle_register_no = $request->vehicle_register_no;
                $shift->delivery_note = $request->delivery_note;
                $shift->driver_name = $request->driver_name;
                $shift->turnmans_name = $request->turnmans_name;
                $shift->shift_date = date('Y-m-d');
                $shift->save();

                \App\Model\NWaInventoryLocationTransfer::where('id', $request->delivery_note)->update(['shift_id' => $shift->id]);

                WaStockMove::where('document_no', $deliveryNote->transfer_no)->update(['shift_id' => $shift->id]);
                return response()->json(['status' => true, 'message' => 'Shift Opened Successfully.']);
            } else {
                return response()->json(['status' => false, 'message' => 'Shift already created with ' . ($request->delivery_note) . '.']);
            }
        }
    }

    public function getroutelist(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $routelist = Route::select('id', 'route_name')->get();
            return response()->json(['status' => true, 'message' => 'Route List.', 'data' => $routelist]);
        }
    }

    public function getUserRouteList(Request $request): JsonResponse
    {
        try {
            $user = JWTAuth::toUser($request->token);


            if (!$user) {
                return response()->json(['status' => false, 'message' => 'Token mismatch'], 422);
            }


            $routelist = Route::with(['centers', 'centers.waRouteCustomers', 'routePlan', 'routePlan.segments'])
                ->withCount(['centers'])
                ->withCount(['waRouteCustomer as shops'])
                ->where("id", $user->route)->get();


            // Calculate and add the distance property to each route
            $routelist->map(function ($route) {
                return $this->getRouteDetails($route);
            });

            return response()->json(['status' => true, 'message' => 'Route List.', 'routes' => $routelist]);
        } catch (\Throwable $e) {
            return response()->json([
                'status' => false,
                'message' => 'An error was encountered.',
                'err' => $e->getMessage(),
                'trace' => $e->getTrace
                ()
            ], 500);
        }
    }

    private function getRouteDetails($route, $lat = null, $lng = null)
    {
        $route->duration = "0m";
        $routeDistance = "0km";
        if ($route->routePlan) {
            $route->start_lat = $route->routePlan->start_location_latitude;
            $route->start_lng = $route->routePlan->start_location_longitude;

            $lastCenter = $route->centers->last();
            if ($lastCenter) {
                $route->end_lat = (float)$lastCenter->lat;
                $route->end_lng = (float)$lastCenter->lng;
            }

            $routeDistance = $route->routePlan->segments->sum('distance_estimate');
            $route->distance = round($routeDistance, 2) . " Km"; // in kilometers

            $routeDurationInMinutes = $route->routePlan->segments->sum('time_estimate');
            if ($routeDurationInMinutes < 60) {
                $route->duration = "{$routeDurationInMinutes}m";
            } else {
                $hours = floor($routeDurationInMinutes / 60);
                $route->duration = "{$hours}h";

                $minutes = fmod($routeDurationInMinutes, 60);
                if ($minutes > 0) {
                    $route->duration = "$route->duration {$minutes}m";
                }
            }
        }

        $route->order_taking_day = Carbon::today()->format('Y-m-d');
        $route->items_to_be_received = true;
        $today = Carbon::today();
        $dayOfWeek = $today->dayOfWeek;

        if ($dayOfWeek === $route->order_taking_day) {
            $route->is_order_taking_day = true;
        } else {
            $route->is_order_taking_day = false;
        }

        $orders = WaInternalRequisition::where('route_id', $route->id)->where('status', '!=', 'COMPLETED')->count();


        if ($orders > 0) {
            $route->items_to_be_received = true;

        } else {
            $route->items_to_be_received = false;

        }


        $route->target_amount = $this->formatMoney(300000); // Dummy Data
        $route->target_balance = $this->formatMoney(300000); // Dummy Data

        $route->target_percentage = 0.0;

        foreach ($route->centers as $c) {
            $c->duration = "1m";
            $c->distance = "1 km";
            $c->lat = (float)$c->lat;
            $c->lng = (float)$c->lng;

            if ($lat && $lng) {
                $distanceFromUser = $this->getDistanceBetweenPoints((float)$lat, (float)$lng, $c->lat, $c->lng);
                $c->distance = "" . round(($distanceFromUser / 1000), 2) . " km";
                //                $c->duration = $this->getDurationBetweenLocations($c->lat, $c->lng, (float)$lat, (float)$lng, 'AIzaSyCiKA38J54kh5ZrI9J7kTOox8_4sI21TAc');
            }

            foreach ($c->waRouteCustomers as $shop) {
                $shop->duration = "1m";
                $shop->distance = "1 km";

                if ($lat && $lng) {
                    $distanceFromUser = $this->getDistanceBetweenPoints((float)$lat, (float)$lng, $shop->lat, $shop->lng);
                    $shop->distance = "" . round(($distanceFromUser / 1000), 2) . " km";
                    //                $c->duration = $this->getDurationBetweenLocations($c->lat, $c->lng, (float)$lat, (float)$lng, 'AIzaSyCiKA38J54kh5ZrI9J7kTOox8_4sI21TAc');
                }
            }
        }

        return $route;
    }

    private function getDistanceBetweenPoints($lat1, $lon1, $lat2, $lon2): float
    {
        $theta = $lon1 - $lon2;
        $miles = (sin(deg2rad($lat1)) * sin(deg2rad($lat2))) + (cos(deg2rad($lat1)) * cos(deg2rad($lat2)) * cos(deg2rad($theta)));
        $miles = acos($miles);
        $miles = rad2deg($miles);
        $miles = $miles * 60 * 1.1515;
        $feet = $miles * 5280;
        $yards = $feet / 3;
        $kilometers = $miles * 1.609344;
        $meters = $kilometers * 1000;

        return $meters;
    }


    function getDurationBetweenLocations($originLat, $originLng, $destinationLat, $destinationLng, $apiKey)
    {
        $client = new Client();
        $response = $client->get('https://maps.googleapis.com/maps/api/distancematrix/json', [
            'query' => [
                'origins' => $originLat . ',' . $originLng,
                'destinations' => $destinationLat . ',' . $destinationLng,
                'key' => $apiKey,
            ],
        ]);

        $data = json_decode($response->getBody(), true);

        if ($data['status'] === 'OK') {
            return $data['rows'][0]['elements'][0]['duration']['text'];
        }

        return 'N/A'; // Handle the case when the API request fails
    }


    public function routeDeliveryCentres(Request $request)
    {
        try {
            $validator = Validator::make($request->all(), [
                'route_id' => 'required',
            ]);

            if ($validator->fails()) {
                $error = $this->validationHandle($validator->messages());
                return response()->json(['status' => false, 'message' => $error]);
            }


            $route = Route::with(['centers', 'centers.waRouteCustomers', 'routePlan', 'routePlan.segments'])->find($request->route_id);
            $routeDetails = $this->getRouteDetails($route, $request->latitude, $request->longitude);

            //        // Calculate and add the distance property to each route
//        $start_lat = $route->start_lat;
//        $end_lat = $route->end_lat;
//
//        $end_lng = $route->end_lng;
//        $start_lng = $route->start_lng;
//
//
//        $route->distance = round($this->calculateDistance($start_lat, $start_lng, $end_lat, $end_lng), 2) . " Km";
//        $route->duration = "2 hrs";
//        $route->target_amount = $this->formatMoney(300000); // Dummy Data
//        $route->target_balance = $this->formatMoney(300000); // Dummy Data
//        $route->is_order_taking_day = true;
//
//        $route->order_taking_day = Carbon::today()->format('Y-m-d');
//
//
//        $centres = DeliveryCentres::with('waRouteCustomers')
//            // ->leftJoin('wa_route_customers', 'delivery_centres.id', '=', 'wa_route_customers.delivery_centres_id')
//            ->withCount(['waRouteCustomers as unvisited_shops'])
//            ->withCount(['waRouteCustomers as shops'])
//            ->where('delivery_centres.route_id', $request->route_id)->get();
//
//
//        $centres->map(function ($centre) use ($route) {
//            $start_lat = $route->start_lat;
//            $end_lat = $centre->end_lat;
//
//            $end_lng = $centre->lng;
//            $start_lng = $route->start_lng;
//
//
//            $centre->distance = round($this->calculateDistance($start_lat, $start_lng, $end_lat, $end_lng), 2) . " Km away";
//            $centre->duration = "40 Min";
//
//            return $centre;
//        });
//
//
//        $centresCount = count($centres);
//        $shopsCount = WaRouteCustomer::where("route_id", $request->route_id)->count();
//
//        $route->shops_count = $centresCount;
//        $route->centers_count = $shopsCount;


            return response()->json(['status' => true, 'message' => 'Delivery Centres', 'route' => $routeDetails, 'centres' => $routeDetails->centers]);
        } catch (\Throwable $e) {
            return response()->json(['status' => false, 'message' => $e->getMessage(), 'trace' => $e->getTrace()]);
        }
    }

    public function getUserShops(Request $request): JsonResponse
    {
        $user = JWTAuth::toUser($request->token);

        if ($user) {
//            $shops = DB::table('wa_route_customers')->whereIn("route_id", $user->routes->pluck('id'))->get();
            $shops = WaRouteCustomer::with('route')->whereIn("route_id", $user->routes->pluck('id'))->get();

            $shops->map(function ($shop) use ($user, $request) {
                $shop->distance = '0 Km away';
                $shop->can_edit = false;

                if ($shop->created_by == 0) {
                    $shop->can_edit = true;
                }

                if ($request->latitude && $request->longitude) {
                    $originLat = (float)$request->latitude;
                    $originLng = (float)$request->longitude;
                    $destinationLat = $shop->lat;
                    $destinationLng = $shop->lng;

                    $shop->distance = MappingService::getDistanceBetweenPoints($originLat, $originLng, $destinationLat, $destinationLng);
                    $shop->distance = round($shop->distance / 1000, 2) . "Km away";
                }

                if ($shop->image_url) {
                    $appUrl = env('APP_URL');
                    $shop->photo = "$appUrl/uploads/shops/" . $shop->image_url;
                }

                $shop->route = $this->getBasicRouteInformation(route: Route::find($shop->route_id), user: $user);
                unset($shop->route->centers);
                unset($shop->route->sections);

                return $shop;
            });

            return response()->json(['status' => true, 'shops' => $shops]);
        } else {
            return response()->json(['status' => false, 'message' => 'A user matching the provided token was not found.'], 422);
        }
    }

    public function getShopDetails(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'shop_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        }

        $user = JWTAuth::toUser($request->token);

        if ($user) {
            $shops = WaRouteCustomer::find($request->shop_id);

            $shopVerified = false;

            if ($shops->is_verified == 1) {
                $shopVerified = true;
            }

            $shops->is_verified = $shopVerified;


            $allItems = WaInternalRequisition::withCount('getRelatedItem as number_of_items')
                ->with('getRelatedItem.getInventoryItemDetail')
                ->where('wa_route_customer_id', $request->shop_id)->orderBy('id', 'DESC')->get();

            $totalPendingOrdersAmount = 0;

            foreach ($allItems as $item) {
                // Access the 'getRelatedItem' relationship for each item


                $relatedItems = $item->getRelatedItem;

                // Calculate the total sum for this item
                $totalSum = 0;
                foreach ($relatedItems as $relatedItem) {
                    $totalSum += $relatedItem->standard_cost * $relatedItem->quantity;
                    if ($item->status != "COMPLETED") {
                        $totalPendingOrdersAmount = $totalPendingOrdersAmount + ($relatedItem->standard_cost * $relatedItem->quantity);

                    }
                }

                $item->totalOrderAmount = $this->formatMoney($totalSum);

                // Add the total sum to each relatedItem object
                // foreach ($relatedItems as $relatedItem) {

                // }
            }

            return response()->json(['status' => true, 'shops' => $shops, 'totalPendingAmount' => $totalPendingOrdersAmount, "orders" => $allItems]);
        } else {
            return response()->json(['status' => false, 'message' => 'User nor found']);
        }
    }

    public function getMyDebtorList(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $query = "from wa_salesman_trans as ab join wa_shifts on wa_shifts.id = ab.shift_id where wa_shifts.status = 'open' 
                AND ab.invoice_customer_name = wa_salesman_trans.invoice_customer_name 
                AND ab.wa_customer_id = wa_customers.id AND DATE(ab.trans_date) >= '2022-06-01' 
                AND ab.salesman_user_id = " . $request->user_id . " 
                AND type_number != 109 
                order by ab.id desc limit 1";
            $mydebtorlist = DB::table('wa_customers')->select(
                'wa_customers.customer_code',
                DB::RAW('(select ab.id ' . $query . ') as debtor_id'),
                // 'wa_salesman_trans.invoice_customer_name as customer_name',
                'customer_name',
                DB::RAW('(select ab.trans_date ' . $query . ') as trans_date'),
                DB::RAW('(select ab.trans_date ' . $query . ') as trans_dates'),
                DB::RAW('(select ab.document_no ' . $query . ') as document_no'),
                DB::RAW('(select ab.shift_id ' . $query . ') as shift_id'),
                DB::RAW('sum(wa_salesman_trans.amount) as balance'),
                DB::RAW('(select ab.invoice_customer_name ' . $query . ') as invoice_customer_name'),
                DB::RAW("(select ab.reference " . $query . ") as reference")
            )
                ->join('wa_salesman_trans', 'wa_salesman_trans.wa_customer_id', '=', 'wa_customers.id')
                ->join('wa_shifts', function ($e) {
                    $e->on('wa_shifts.id', '=', 'wa_salesman_trans.shift_id')->where('status', 'open');
                })
                ->where('wa_salesman_trans.salesman_user_id', $request->user_id)
                ->having('balance', '>', '0')
                ->whereDate('wa_salesman_trans.trans_date', '>=', '2022-08-30')
                ->groupBy('wa_salesman_trans.shift_id')
                ->orderBy('trans_dates', 'DESC')
                ->get();

            return response()->json(['status' => true, 'message' => 'My Debtors List.', 'data' => $mydebtorlist]);
        }
    }


    public function getvehicleslist(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $vehiclelist = Vehicle::select('id', 'vehicle_reg')->get();
            return response()->json(['status' => true, 'message' => 'Vehicle List.', 'data' => $vehiclelist]);
        }
    }

    public function closeShift(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'shift_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            WaShift::where('id', $request->shift_id)->update(['status' => 'close']);
            return response()->json(['status' => true, 'message' => 'Shift closed successfully.']);
        }
    }


    function createImageFromBase64(Request $request)
    {
        $file_data = $request->input('image_file');
        $file_name = 'image_' . time() . '.png'; //generating unique file name;

        if ($file_data != "") { // storing image in storage/app/public Folder
            Storage::disk('uploads')->put($file_name, base64_decode($file_data));
        }
    }

    public function getShiftSalesSummary(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $date = \Carbon\Carbon::today()->subDays(7);

            //$getshiftdata =    
            $mydebtorlist = WaCustomer::select('customer_code', 'order_date', 'customer_name', 'wa_cash_sales.order_date as trans_date', 'wa_cash_sales.cash_sales_number', 'wa_cash_sales.id as cash_sales_id')
                ->join('wa_cash_sales', 'wa_cash_sales.wa_customer_id', '=', 'wa_customers.id')
                ->where('wa_cash_sales.creater_id', $request->user_id)
                //->groupBy('customer_code')
                ->where('order_date', '>=', $date)
                ->orderBy('wa_cash_sales.order_date', 'DESC')
                ->get();
            foreach ($mydebtorlist as $key => $val) {
                $mydebtorlist[$key]->balance = WaCashSalesItem::where('wa_cash_sales_id', $val->cash_sales_id)->sum(DB::raw('unit_price * quantity'));
            }

            return response()->json(['status' => true, 'message' => 'My Shift Sales List.', 'data' => $mydebtorlist]);
        }
    }


    public function getExpensesSummary(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $getOpenShifts = WaShift::select('shift_id', 'id')->where('status', 'open')->where('salesman_id', $request->user_id)->get();
            foreach ($getOpenShifts as $k => $value) {
                $getOpenShifts[$k]->expenseList = WaChartsOfAccount::select('wa_charts_of_accounts.id', 'wa_shifts.shift_id', 'wa_shifts.id as shiftid', 'wa_charts_of_accounts.account_name', 'wa_charts_of_accounts.account_code')
                    ->where('wa_account_groups.slug', 'salesman-expenses')
                    ->join('wa_account_groups', 'wa_account_groups.id', '=', 'wa_charts_of_accounts.wa_account_group_id')
                    ->join('wa_gl_trans', 'wa_gl_trans.account', '=', 'wa_charts_of_accounts.account_code')
                    ->join('wa_shifts', 'wa_shifts.id', '=', 'wa_gl_trans.shift_id')
                    ->where('amount', '>', '0')
                    ->where('wa_shifts.id', $value->id)
                    ->groupBy('wa_shifts.id')
                    ->get();
                $totalExp = 0;
                foreach ($getOpenShifts[$k]->expenseList as $key => $val) {
                    $getOpenShifts[$k]->expenseList[$key]->total_exp = WaGlTran::where('amount', '>', 0)->where('shift_id', $val->shiftid)->where('account', $val->account_code)->sum('amount');
                    $totalExp += WaGlTran::where('amount', '>', 0)->where('shift_id', $val->shiftid)->where('account', $val->account_code)->sum('amount');
                }
                $getOpenShifts[$k]->totalExpensesAmount = $totalExp;
            }


            return response()->json(['status' => true, 'message' => 'My Expenses List.', 'data' => $getOpenShifts]);
        }
    }

    public function postDebtorPayment(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'debtor_id' => 'required',
            'amount' => 'required',
            'gl_account_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $grn_number = getCodeWithNumberSeriesRCT('RECEIPT');
            // $query = "from wa_debtor_trans as ab where ab.invoice_customer_name = wa_debtor_trans.invoice_customer_name AND ab.wa_customer_id = wa_customers.id AND DATE(ab.trans_date) >= '2021-09-27' AND ab.salesman_user_id = ".$request->user_id." order by ab.id desc limit 1";
            // $mydebtorlist = WaCustomer::select(
            //     DB::RAW('(select ab.id '.$query.') as debtor_id'),
            //     DB::RAW('sum(wa_debtor_trans.amount) as balance'),
            //     DB::RAW('(select ab.trans_date '.$query.') as trans_dates'),
            //     DB::RAW('(select ab.invoice_customer_name '.$query.') as invoice_customer_name')
            // )
            // ->join('wa_debtor_trans','wa_debtor_trans.wa_customer_id','=','wa_customers.id')
            // ->where('wa_debtor_trans.salesman_user_id',$request->user_id)
            // ->having('balance','>','0')
            // ->having('debtor_id',$request->debtor_id)
            // ->whereDate('wa_debtor_trans.trans_date','>=','2021-09-27')
            // ->groupBy('wa_debtor_trans.invoice_customer_name')
            // ->orderBy('trans_dates','DESC')
            // ->first();
            // // dd($mydebtorlist);
            // if(!$mydebtorlist || $mydebtorlist->balance < $request->amount){
            //     return response()->json(['status'=>false,'message'=>'Selected Amount cannot be greater than Debtor total']);
            // }
            // return response()->json(['status'=>false,'message'=>'Test']);

            DB::transaction(function () use ($request, $grn_number) {


                $dateTime = date('Y-m-d H:i:s');
                $accountuingPeriod = WaAccountingPeriod::where('is_current_period', '1')->first();
                $debtorData = \App\Model\WaSalesmanTran::where('id', $request->debtor_id)->first();
                $shiftid = WaShift::where('id', $debtorData->shift_id)->first();
                $series_module = WaNumerSeriesCode::where('module', 'RECEIPT')->first();
                $getUserData = User::where('id', $request->user_id)->first();
                if ($request->gl_account_id == 163) {
                    $item = new \App\Model\BankEquityTransaction;
                    $item->user_id = $request->user_id;
                    $item->billNumber = $grn_number;
                    $item->billAmount = -$request->amount;
                    $item->CustomerRefNumber = $debtorData->customer_number;
                    $item->bankreference = NULL;
                    $item->tranParticular = $series_module->type_number;
                    $item->paymentMode = 'Debit';
                    $item->transactionDate = $dateTime;
                    $item->phonenumber = NULL;
                    $item->debitaccount = $accountuingPeriod ? $accountuingPeriod->id : null;
                    $item->debitcustname = $debtorData->customer_number;
                    $item->transaction_type = 'Debit';
                    $item->save();
                }

                // if ($request->gl_account_id != 38) {
                // $saveDebtor = new WaDebtorTran();
                // $saveDebtor->wa_sales_invoice_id = $debtorData->wa_sales_invoice_id;
                // $saveDebtor->salesman_id =  $getUserData->wa_location_and_store_id;
                // $saveDebtor->salesman_user_id = $request->user_id;
                // $saveDebtor->user_id = $request->user_id;
                // $saveDebtor->paid_by = @$getUserData->name;
                // $saveDebtor->type_number = $series_module->type_number;
                // $saveDebtor->wa_customer_id = $debtorData->wa_customer_id;
                // $saveDebtor->customer_number = $debtorData->customer_number;
                // $saveDebtor->trans_date = $dateTime;
                // $saveDebtor->input_date = $dateTime;
                // $saveDebtor->shift_id	 = @$shiftid->id; //$debtorData->shift_id;
                // $saveDebtor->wa_accounting_period_id = $accountuingPeriod ? $accountuingPeriod->id : null;;
                // $saveDebtor->reference = $debtorData->reference;
                // $saveDebtor->invoice_customer_name = $debtorData->invoice_customer_name;
                // $saveDebtor->amount = '-'.$request->amount;
                // $saveDebtor->document_no = $grn_number;
                // $saveDebtor->save();		
                // }
                if ($request->gl_account_id == 41) {
                    $file_data = $request->input('chequepic');
                    $file_name = 'cheque__' . $dateTime . '.png'; //generating unique file name;

                    if ($file_data != "") { // storing image in storage/app/public Folder
                        Storage::disk('uploads')->put($file_name, base64_decode($file_data));
                    }
                } else {
                    $file_name = "";
                }
                $methodAccId = WaChartsOfAccount::where('id', $request->gl_account_id)->first();
                $Debtor = new \App\Model\WaSalesmanTran();
                $Debtor->wa_sales_invoice_id = $debtorData->wa_sales_invoice_id;
                $Debtor->salesman_id = $getUserData->wa_location_and_store_id;
                $Debtor->salesman_user_id = $request->user_id;
                $Debtor->user_id = $request->user_id;
                $Debtor->paid_by = @$getUserData->name;
                $Debtor->type_number = $series_module->type_number;
                $Debtor->wa_customer_id = $debtorData->wa_customer_id;
                $Debtor->customer_number = $debtorData->customer_number;
                $Debtor->trans_date = $dateTime;
                $Debtor->input_date = $dateTime;
                $Debtor->shift_id = @$shiftid->id; //$debtorData->shift_id;
                $Debtor->wa_accounting_period_id = $accountuingPeriod ? $accountuingPeriod->id : null;;
                $Debtor->reference = $debtorData->reference;
                $Debtor->invoice_customer_name = $debtorData->invoice_customer_name;
                $Debtor->amount = '-' . $request->amount;
                $Debtor->cheque_image = 'public/uploads/cheque_images/' . $file_name;
                $Debtor->narrative = @$request->referencecode;
                $Debtor->account = @$methodAccId->account_code;
                $Debtor->document_no = $grn_number;
                $Debtor->is_cheque_trans = (!empty($file_name)) ? 1 : 0;
                if ($request->gl_account_id != 38) {
                    $id = DB::table('wa_merged_payments')->insertGetId([
                        'shift_id' => $debtorData->shift_id,
                        'salesman_user_id' => $request->user_id,
                        'amount' => $request->amount,
                        'payment_account' => @$methodAccId->account_code,
                        'narration' => $request->referencecode,
                        'description' => @$request->comment,
                        'trans_date' => $dateTime,
                        'transaction_no' => $grn_number,
                        'shift' => @$shiftid->shift_id,
                        'salesman_id' => @$getUserData->wa_location_and_store_id,
                        'check_image' => (!empty($file_name)) ? 'public/uploads/cheque_images/' . $file_name : NULL,
                        'is_cheque_trans' => 1
                    ]);
                    $Debtor->wa_merged_id = $id;
                    $Debtor->is_settled = 1;
                }
                $Debtor->save();

                /*
                     if($request->gl_account_id==2){
                         $accountNo = '13004';
                     }else{
                         $accountNo = $methodAccId->account_code;
                     }   
    */


                // $dr =  new WaGlTran();
                // $dr->period_number = $accountuingPeriod ? $accountuingPeriod->period_no : null;
                // $dr->grn_type_number = $series_module->type_number;
                // $dr->grn_last_used_number = $series_module->last_number_used;
                // $dr->transaction_type = $series_module->description;
                // $dr->transaction_no =  $grn_number;
                // $dr->trans_date = $dateTime;
                // $dr->restaurant_id = $getUserData->restaurant_id;
                // $dr->period_number = null;
                // $dr->salesman_id = $request->user_id;
                // $dr->shift_id	 = $debtorData->shift_id;
                // $dr->account = '13004';
                // $dr->amount = '-' . $request->amount;
                // $dr->narrative = @$request->referencecode;
                // $dr->reference = @$request->comment;

                // //$dr->narrative = $val->stockcode . '/' . $WaInventoryItem->title . '/' . $val->standard_cost . '@' . $val->quantity;
                // $dr->save();	   

                // $dr =  new WaGlTran();
                // $dr->period_number = $accountuingPeriod ? $accountuingPeriod->period_no : null;
                // $dr->grn_type_number = $series_module->type_number;
                // $dr->grn_last_used_number = $series_module->last_number_used;
                // $dr->transaction_type = $series_module->description;
                // $dr->transaction_no =  $grn_number;
                // $dr->trans_date = $dateTime;
                // $dr->restaurant_id = $getUserData->restaurant_id;
                // $dr->period_number = null;
                // $dr->shift_id	 = $debtorData->shift_id;
                // $dr->cheque_image = 'public/uploads/cheque_images/'.$file_name;
                // $dr->account = @$methodAccId->account_code;
                // $dr->amount = $request->amount;
                // $dr->narrative = @$request->referencecode;
                // $dr->reference = @$request->comment;

                // //$dr->narrative = $val->stockcode . '/' . $WaInventoryItem->title . '/' . $val->standard_cost . '@' . $val->quantity;
                // $dr->save();	                    

                updateUniqueNumberSeries('RECEIPT', $grn_number);
            });

            return response()->json(['status' => true, 'message' => 'Debtor Payment Successfully Posted.', 'transaction_no' => $grn_number]);
        }
    }


    public function getdeliverynotelist(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $getUserData = User::where('id', $request->user_id)->first();

            $list = \App\Model\NWaInventoryLocationTransfer::select('id', 'transfer_no')->where('to_store_location_id', $getUserData->wa_location_and_store_id)->where('shift_id', null)->get();
            return response()->json(['status' => true, 'message' => 'Transfer List.', 'data' => $list]);
        }
    }

    public function getcashpaymentlist(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'shift_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $shiftids = WaShift::where('salesman_id', $request->get('user_id'))->pluck('id');

            $list = DB::table('wa_salesman_trans')->select('id', 'reference', 'cheque_image', 'trans_date', 'account', 'narrative', 'amount')
                ->where('amount', '<', '0')
                ->where('shift_id', $request->shift_id)
                ->where('type_number', '12')
                ->where('is_cheque_trans', 0)
                ->where('is_settled', 0)
                ->orderBy('trans_date', 'DESC')
                ->get()->map(function ($item) {
                    $item->amount = abs($item->amount);
                    return $item;
                });

            return response()->json(['status' => true, 'message' => 'Cash Payment List.', 'data' => $list]);
        }
    }

    public function postSplitPayment(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'gl_trans_id' => 'required',
            'amount' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $originalRow = \App\Model\WaSalesmanTran::where('id', $request->gl_trans_id)->first();

            if ($originalRow->amount == $request->amount) {
                return response()->json(['status' => false, 'message' => 'Do not have any changes.']);
            } else {
                $copyRow = new \App\Model\WaSalesmanTran();
                $copyRow->wa_sales_invoice_id = $originalRow->wa_sales_invoice_id;
                $copyRow->salesman_id = $originalRow->salesman_id;
                $copyRow->salesman_user_id = $originalRow->salesman_user_id;
                $copyRow->user_id = $originalRow->user_id;
                $copyRow->paid_by = $originalRow->paid_by;
                $copyRow->type_number = $originalRow->type_number;
                $copyRow->wa_customer_id = $originalRow->wa_customer_id;
                $copyRow->customer_number = $originalRow->customer_number;
                $copyRow->trans_date = $originalRow->trans_date;
                $copyRow->input_date = $originalRow->input_date;
                $copyRow->shift_id = $originalRow->shift_id; //$debtorData->shift_id;
                $copyRow->wa_accounting_period_id = $originalRow->wa_accounting_period_id;
                $copyRow->reference = $originalRow->reference;
                $copyRow->invoice_customer_name = $originalRow->invoice_customer_name;
                $copyRow->amount = -$request->amount;
                $copyRow->cheque_image = $originalRow->cheque_image;
                $copyRow->narrative = $originalRow->narrative;
                $copyRow->account = $originalRow->account;
                $copyRow->document_no = $originalRow->document_no;
                $copyRow->is_cheque_trans = $originalRow->is_cheque_trans;

                $originalRow->amount = $originalRow->amount + $request->amount;
                $originalRow->save();

                $copyRow->save();

                return response()->json(['status' => true, 'message' => 'Amount splitted successfully.']);
            }
        }
    }

    public function postmergecashsalesinmpesa(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'shift_id' => 'required',
            'gl_account' => 'required',
            'referencecode' => 'required',
            'comment' => 'required',
            'id' => 'required',
            'total_amount' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $series_module = WaNumerSeriesCode::where('module', 'POS')->first();
            $dateTime = date('Y-m-d H:i:s');
            $grn_number = getCodeWithNumberSeriesPOS('POS');
            //  echo $grn_number; die;
            //   echo "<pre>"; print_r($request->all()); die("Ok");
            $accountuingPeriod = WaAccountingPeriod::where('is_current_period', '1')->first();
            $getUserData = User::where('id', $request->user_id)->first();


            // $shiftid = WaShift::where('id',$request->shift_id)->first();
            // $customer = (Object)[];
            // if($shiftid){
            // $shiftid = WaShift::where('id',$request->shift_id)->first();
            //     $user = User::find($shiftid->salesman_id);
            //     if($user){
            //         $customer = WaCustomer::where('route_id',$user->route)->first();
            //     }
            // }
            // $saveDebtor = new WaDebtorTran();
            // $saveDebtor->wa_sales_invoice_id = $series_module->id;
            // $saveDebtor->salesman_id =  $getUserData->wa_location_and_store_id;
            // $saveDebtor->salesman_user_id = $request->user_id;
            // $saveDebtor->type_number = $series_module->type_number;
            // $saveDebtor->wa_customer_id = @$customer->id;
            // $saveDebtor->customer_number = @$customer->customer_code;
            // $saveDebtor->trans_date = $dateTime;
            // $saveDebtor->input_date = $dateTime;
            // $saveDebtor->shift_id	 = @$request->shift_id; //$debtorData->shift_id;
            // $saveDebtor->wa_accounting_period_id = $accountuingPeriod ? $accountuingPeriod->id : null;;
            // $saveDebtor->reference = $request->comment;
            // $saveDebtor->invoice_customer_name = @$customer->customer_name;
            // $saveDebtor->amount = '-'.$request->total_amount;
            // $saveDebtor->document_no = $grn_number;
            // $saveDebtor->save();	


            // $dr =  new WaGlTran();
            // $dr->period_number = $accountuingPeriod ? $accountuingPeriod->period_no : null;
            // $dr->grn_type_number = $series_module->type_number;
            // $dr->grn_last_used_number = $series_module->last_number_used;
            // $dr->transaction_type = $series_module->description;
            // $dr->transaction_no =  $grn_number;
            // $dr->salesman_id = $request->user_id;
            // $dr->trans_date = $dateTime;
            // $dr->restaurant_id = $getUserData->restaurant_id;

            // $dr->shift_id	 = $request->shift_id;
            // $dr->account = $request->gl_account;
            // $dr->amount = $request->total_amount;
            // $dr->narrative = $request->referencecode;
            // $dr->reference = @$request->comment;
            // $dr->save();
            $shiftid = WaShift::where('id', $request->shift_id)->first();

            $id = DB::table('wa_merged_payments')->insertGetId([
                'shift_id' => $request->shift_id,
                'salesman_user_id' => $request->user_id,
                'amount' => $request->total_amount,
                'payment_account' => $request->gl_account,
                'narration' => $request->referencecode,
                'description' => @$request->comment,
                'trans_date' => $dateTime,
                'transaction_no' => $grn_number,
                'shift' => @$shiftid->shift_id,
                'salesman_id' => @$getUserData->wa_location_and_store_id
            ]);
            \App\Model\WaSalesmanTran::whereIn("id", $request->id)->update(['wa_merged_id' => $id, 'is_settled' => 1]);

            updateUniqueNumberSeries('POS', $grn_number);
            return response()->json(['status' => true, 'message' => 'Cash Payment Merged Successfully.', 'transaction_no' => $grn_number]);
        }
    }


    public function salesmanTripSummary(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'wa_location_and_store_id' => 'required',
            "shift_id" => "required|array|min:1",
            "shift_id.*" => "required|distinct|min:1",
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $detail = [];
            $all_item = WaStockMove::select('*')->groupBy('wa_inventory_item_id');
            if ($request->has('wa_location_and_store_id') && $request->wa_location_and_store_id) {
                $all_item->where('wa_location_and_store_id', $request->wa_location_and_store_id);
            }
            if ($request->has('shift_id') && $request->shift_id) {
                $all_item->whereIn('shift_id', $request->shift_id);
            }
            $all_item = $all_item->get();

            foreach ($all_item as $key => $val) {

                $itemtaken = WaStockMove::where('stock_adjustment_id', null)
                    ->where('wa_inventory_item_id', $val->wa_inventory_item_id)
                    ->where('qauntity', '<', 0);
                if ($request->has('wa_location_and_store_id') && $request->wa_location_and_store_id) {
                    $itemtaken->where('wa_location_and_store_id', $request->wa_location_and_store_id);
                }
                if ($request->has('shift_id') && $request->shift_id) {
                    $itemtaken->whereIn('shift_id', $request->shift_id);
                }
                $itemtaken = $itemtaken->sum('qauntity');

                $all_item[$key]->item_sold = abs($itemtaken);

                $avgamount = WaStockMove::where('stock_adjustment_id', null)
                    ->where('wa_inventory_item_id', $val->wa_inventory_item_id);
                if ($request->has('wa_location_and_store_id') && $request->wa_location_and_store_id) {
                    $avgamount->where('wa_location_and_store_id', $request->wa_location_and_store_id);
                }
                if ($request->has('shift_id') && $request->shift_id) {
                    $avgamount->whereIn('shift_id', $request->shift_id);
                }
                $avgamount->where('qauntity', '<', 0);
                $avgamount = $avgamount->sum(DB::raw('price * qauntity'));

                $all_item[$key]->avg_price = (abs($itemtaken) > 0) ? ($avgamount / $itemtaken) : 0;

                $all_item[$key]->total_sale = abs((abs($itemtaken) > 0) ? ($all_item[$key]->avg_price * $itemtaken) : 0);
            }
            return response()->json(['status' => true, 'message' => 'Salesman Trip Summary.', 'data' => $all_item]);
        }
    }

    public function checkminimumprice()
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'old_price' => 'required',
            'entered_price' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            if ($request->old_price > $request->entered_price) {
                return response()->json(['status' => true, 'message' => 'Success.']);
            } else {
                return response()->json(['status' => false, 'message' => 'Selling price always greater than to purchase price (' . $request->old_price . ').']);
            }
        }
    }

    public function getsalesreportPrint(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'cash_sales_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $data = WaCashSales::select('order_date', 'id', 'wa_customer_id', 'cash_sales_number')->with('getRelatedItem', 'getRelatedCustomer')->where('id', $request->cash_sales_id)->first();
            return response()->json(['status' => true, 'message' => 'Cash Sales Item.', 'data' => $data]);
        }
    }

    public function getshiftsummaryPrint(Request $request)
    {
        //	    echo "sdf"; die;
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'shift_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $lists = WaCashSales::orderBy('id', 'desc')->where('shift_id', $request->shift_id)->get();
            if (count($lists) > 0) {
                foreach ($lists as $key => $list) {
                    $amnt = 0;
                    if (count($list->getRelatedItem) > 0) {
                        foreach ($list->getRelatedItem as $keys => $val) {
                            $amnt += ($val->unit_price * $val->quantity);
                        }
                    }
                    $lists[$key]->customer_name = @$list->getRelatedCustomer->customer_name;
                    $lists[$key]->total_amount = $amnt;
                }
            }
            // echo "<pre>"; print_r($lists); die;
            //  $data =  WaCashSales::select('order_date','id')->with('getRelatedItem')->where('id',$request->cash_sales_id)->first();
            return response()->json(['status' => true, 'message' => 'Shift Cash Sales.', 'data' => $lists]);
        }
    }


    public function bank_transaction(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'from_date' => 'nullable|date',
            'to_date' => 'nullable|date',
            // 'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        }
        // $locationid = -1;
        // $user = User::where('id',$request->user_id)->first();
        // if($user){
        //     $locationid = $user->wa_location_and_store_id;
        // }
        $data = \App\Model\BankEquityTransaction::where(function ($w) use ($request) {
            // $w->where('billAmount','<',0);
            if ($request->from_date) {
                $w->whereBetween('transactionDate', [$request->from_date . ' 00:00:00', $request->to_date . ' 23:59:59']);
            } else {
                $w->whereDate('transactionDate', date('Y-m-d'));
            }
        })
            // ->where('transaction_type','Credit')
            ->where('user_id', $request->user_id)
            // ->where('wa_location_and_store_id',$locationid)
            ->get()->map(function ($item) {
                if ($item->billAmount < 0) {
                    $item->billAmount = -($item->billAmount);
                }
                return $item;
            });
        return response()->json(['status' => true, 'message' => 'Daily Summary Report', 'data' => $data]);
    }

    public function getTotalBankEquityTransactions(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        }
        //  $locationid = -1;
        //  $user = User::where('id',$request->user_id)->first();
        //  if($user){
        //      $locationid = $user->wa_location_and_store_id;
        //  }
        $total = \App\Model\BankEquityTransaction::where('transaction_type', 'Debit')
            ->where('user_id', $request->user_id)
            // ->where('wa_location_and_store_id',$locationid)
            ->sum('billAmount');
        $total1 = \App\Model\BankEquityTransaction::where('transaction_type', 'Credit')->where('user_id', $request->user_id)->sum('billAmount');
        return response()->json(['status' => true, 'message' => 'Total Bank Equity Balance', 'total_bank_balance' => $total + $total1]);
    }

    public function postDebtorPayment_new(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'user_id' => 'required',
            'debtor_id' => 'required',
            'amount' => 'required',
            'gl_account_id' => 'required',
        ]);
        if ($validator->fails()) {
            $error = $this->validationHandle($validator->messages());
            return response()->json(['status' => false, 'message' => $error]);
        } else {
            $total1 = \App\Model\BankEquityTransaction::where('transaction_type', 'Debit')
                ->where('user_id', $request->user_id)
                ->sum('billAmount');
            $total2 = \App\Model\BankEquityTransaction::where('transaction_type', 'Credit')->where('user_id', $request->user_id)->sum('billAmount');
            $total = $total1 + $total2;
            if ($total < $request->amount) {
                return response()->json(['status' => false, 'message' => 'Your Payment amount is invalid as it exceed bank balance']);
            }
            $series_module = WaNumerSeriesCode::where('module', 'RECEIPT')->first();
            $dateTime = date('Y-m-d H:i:s');
            $grn_number = getCodeWithNumberSeriesRCT('RECEIPT');

            $debtorData = WaDebtorTran::where('id', $request->debtor_id)->first();
            $shiftid = WaShift::where('shift_id', $debtorData->reference)->first()->id;

            $accountuingPeriod = WaAccountingPeriod::where('is_current_period', '1')->first();

            $item = new \App\Model\BankEquityTransaction;
            $item->user_id = $request->user_id;
            $item->billNumber = $grn_number;
            $item->billAmount = -$request->amount;
            $item->CustomerRefNumber = $debtorData->customer_number;
            $item->bankreference = NULL;
            $item->tranParticular = $series_module->type_number;
            $item->paymentMode = 'Debit';
            $item->transactionDate = $dateTime;
            $item->phonenumber = NULL;
            $item->debitaccount = $accountuingPeriod ? $accountuingPeriod->id : null;
            $item->debitcustname = $debtorData->customer_number;
            $item->transaction_type = 'Debit';
            $item->save();


            $saveDebtor = new WaDebtorTran();
            $saveDebtor->wa_sales_invoice_id = $series_module->id;
            $saveDebtor->salesman_id = $request->user_id;
            $saveDebtor->type_number = $series_module->type_number;
            $saveDebtor->wa_customer_id = $debtorData->wa_customer_id;
            $saveDebtor->customer_number = $debtorData->customer_number;
            $saveDebtor->trans_date = $dateTime;
            $saveDebtor->input_date = $dateTime;
            $saveDebtor->shift_id = $shiftid; //$debtorData->shift_id;
            $saveDebtor->wa_accounting_period_id = $accountuingPeriod ? $accountuingPeriod->id : null;
            //$saveDebtor->reference = $shiftdata->shift_id;
            $saveDebtor->amount = '-' . $request->amount;
            $saveDebtor->document_no = $grn_number;
            $saveDebtor->save();

            $getUserData = User::where('id', $request->user_id)->first();

            $methodAccId = WaChartsOfAccount::where('id', $request->gl_account_id)->first();

            /*
               if($request->gl_account_id==2){
                   $accountNo = '13004';
               }else{
                   $accountNo = $methodAccId->account_code;
               }   
*/

            if ($request->gl_account_id == 41) {
                $file_data = $request->input('chequepic');
                $file_name = 'cheque__' . $dateTime . '.png'; //generating unique file name;

                if ($file_data != "") { // storing image in storage/app/public Folder
                    Storage::disk('uploads')->put($file_name, base64_decode($file_data));
                }
            } else {
                $file_name = "";
            }

            $dr = new WaGlTran();
            $dr->period_number = $accountuingPeriod ? $accountuingPeriod->period_no : null;
            $dr->grn_type_number = $series_module->type_number;
            $dr->grn_last_used_number = $series_module->last_number_used;
            $dr->transaction_type = $series_module->description;
            $dr->transaction_no = $grn_number;
            $dr->trans_date = $dateTime;
            $dr->restaurant_id = $getUserData->restaurant_id;
            $dr->period_number = null;
            $dr->salesman_id = $request->user_id;
            $dr->shift_id = $debtorData->shift_id;
            $dr->account = '13004';
            $dr->amount = '-' . $request->amount;
            $dr->narrative = $request->referencecode;
            $dr->reference = @$request->comment;

            //$dr->narrative = $val->stockcode . '/' . $WaInventoryItem->title . '/' . $val->standard_cost . '@' . $val->quantity;
            $dr->save();


            $dr = new WaGlTran();
            $dr->period_number = $accountuingPeriod ? $accountuingPeriod->period_no : null;
            $dr->grn_type_number = $series_module->type_number;
            $dr->grn_last_used_number = $series_module->last_number_used;
            $dr->transaction_type = $series_module->description;
            $dr->transaction_no = $grn_number;
            $dr->trans_date = $dateTime;
            $dr->restaurant_id = $getUserData->restaurant_id;
            $dr->period_number = null;
            $dr->shift_id = $debtorData->shift_id;
            $dr->cheque_image = 'public/uploads/cheque_images/' . $file_name;
            $dr->account = $methodAccId->account_code;
            $dr->amount = $request->amount;
            $dr->narrative = $request->referencecode;
            $dr->reference = @$request->comment;

            //$dr->narrative = $val->stockcode . '/' . $WaInventoryItem->title . '/' . $val->standard_cost . '@' . $val->quantity;
            $dr->save();

            updateUniqueNumberSeries('RECEIPT', $grn_number);

            return response()->json(['status' => true, 'message' => 'Debtor Payment Successfully Posted.', 'transaction_no' => $grn_number]);
        }
    }
}
